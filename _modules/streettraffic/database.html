

<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="en" > <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en" > <!--<![endif]-->
<head>
  <meta charset="utf-8">
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>streettraffic.database &mdash; StreetTraffic 0.10 documentation</title>
  

  
  
  
  

  

  
  
    

  

  
  
    <link rel="stylesheet" href="../../_static/css/theme.css" type="text/css" />
  

  

  
        <link rel="index" title="Index"
              href="../../genindex.html"/>
        <link rel="search" title="Search" href="../../search.html"/>
    <link rel="top" title="StreetTraffic 0.10 documentation" href="../../index.html"/>
        <link rel="up" title="Module code" href="../index.html"/> 

  
  <script src="../../_static/js/modernizr.min.js"></script>

</head>

<body class="wy-body-for-nav" role="document">

   
  <div class="wy-grid-for-nav">

    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search">
          

          
            <a href="../../docindex.html" class="icon icon-home"> StreetTraffic
          

          
          </a>

          
            
            
              <div class="version">
                0.10
              </div>
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
              
            
            
              <p class="caption"><span class="caption-text">Contents:</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../intro.html">An Introduction to StreetTraffic&#8217;s</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../modules.html">StreetTraffic Reference</a></li>
</ul>

            
          
        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" role="navigation" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../docindex.html">StreetTraffic</a>
        
      </nav>


      
      <div class="wy-nav-content">
        <div class="rst-content">
          















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="wy-breadcrumbs">
    
      <li><a href="../../docindex.html">Docs</a> &raquo;</li>
        
          <li><a href="../index.html">Module code</a> &raquo;</li>
        
      <li>streettraffic.database</li>
    
    
      <li class="wy-breadcrumbs-aside">
        
            
        
      </li>
    
  </ul>

  
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <h1>Source code for streettraffic.database</h1><div class="highlight"><pre>
<span></span><span class="kn">import</span> <span class="nn">rethinkdb</span> <span class="k">as</span> <span class="nn">r</span>
<span class="kn">from</span> <span class="nn">typing</span> <span class="k">import</span> <span class="n">Dict</span><span class="p">,</span> <span class="n">List</span>
<span class="kn">import</span> <span class="nn">copy</span>
<span class="kn">import</span> <span class="nn">requests</span>
<span class="kn">from</span> <span class="nn">dateutil</span> <span class="k">import</span> <span class="n">parser</span>
<span class="kn">import</span> <span class="nn">datetime</span>
<span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>
<span class="kn">import</span> <span class="nn">time</span>
<span class="kn">import</span> <span class="nn">json</span>
<span class="kn">import</span> <span class="nn">asyncio</span>
<span class="kn">import</span> <span class="nn">threading</span>
<span class="kn">from</span> <span class="nn">shapely.geometry</span> <span class="k">import</span> <span class="n">Point</span><span class="p">,</span> <span class="n">Polygon</span>

<span class="kn">from</span> <span class="nn">.map_resource.utility</span> <span class="k">import</span> <span class="n">Utility</span>


<div class="viewcode-block" id="TrafficData"><a class="viewcode-back" href="../../streettraffic.html#streettraffic.database.TrafficData">[docs]</a><span class="k">class</span> <span class="nc">TrafficData</span><span class="p">:</span>

    <span class="sd">&quot;&quot;&quot;This class deals with traffic data interaction with database</span>

<span class="sd">    Interaction include inserting traffic flow data from `HERE.com` and </span>
<span class="sd">    retriving them.</span>

<span class="sd">    Attributes:</span>
<span class="sd">        conn (connection): The connection to RethinkDB database</span>
<span class="sd">        latest_crawled_batch_id (str): the latest crawled_batch_id of crawled_batch table</span>

<span class="sd">    &quot;&quot;&quot;</span>


    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">database_name</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;Traffic&quot;</span><span class="p">,</span> <span class="n">database_ip</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        When initializing this class, establish a connection towards the database</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">database_ip</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">conn</span> <span class="o">=</span> <span class="n">r</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="s1">&#39;localhost&#39;</span><span class="p">,</span> <span class="mi">28015</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">conn</span> <span class="o">=</span> <span class="n">r</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="n">database_ip</span><span class="p">,</span> <span class="mi">28015</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">database_name</span> <span class="ow">in</span> <span class="n">r</span><span class="o">.</span><span class="n">db_list</span><span class="p">()</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">conn</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">conn</span><span class="o">.</span><span class="n">use</span><span class="p">(</span><span class="n">database_name</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">r</span><span class="o">.</span><span class="n">db_create</span><span class="p">(</span><span class="n">database_name</span><span class="p">)</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">conn</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">conn</span><span class="o">.</span><span class="n">use</span><span class="p">(</span><span class="n">database_name</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">helper_create_tables</span><span class="p">()</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">latest_crawled_batch_id</span> <span class="o">=</span> <span class="n">r</span><span class="o">.</span><span class="n">table</span><span class="p">(</span><span class="s1">&#39;crawled_batch&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">order_by</span><span class="p">(</span><span class="n">index</span> <span class="o">=</span> <span class="n">r</span><span class="o">.</span><span class="n">desc</span><span class="p">(</span><span class="s2">&quot;crawled_timestamp&quot;</span><span class="p">))</span><span class="o">.</span><span class="n">limit</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">conn</span><span class="p">)</span><span class="o">.</span><span class="n">next</span><span class="p">()[</span><span class="s1">&#39;crawled_batch_id&#39;</span><span class="p">]</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="k">pass</span>

<div class="viewcode-block" id="TrafficData.insert_json_data"><a class="viewcode-back" href="../../streettraffic.html#streettraffic.database.TrafficData.insert_json_data">[docs]</a>    <span class="k">def</span> <span class="nf">insert_json_data</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">data</span><span class="p">:</span> <span class="n">Dict</span><span class="p">,</span> <span class="n">crawled_batch_id</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">testing</span> <span class="o">=</span> <span class="kc">False</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;This funciton will analyze a JSON raw data from </span>
<span class="sd">        Here.com and insert cooresponding documents. each documents</span>
<span class="sd">        is associated with a ``crawled_batch_id``, which specifies</span>
<span class="sd">        the time of documents retrieval. </span>

<span class="sd">        Args:</span>
<span class="sd">            data (Dict): The JSON raw data</span>
<span class="sd">            crawled_batch_id (str): the id of `crawled_batch` table, it tells</span>
<span class="sd">                us about the time of documents retrieval</span>

<span class="sd">        Returns:</span>
<span class="sd">            None, although if testing = True, we would return a tuple </span>
<span class="sd">            (original_data_insertion_ids, flow_data_insertion_ids, road_data_insertion_ids)</span>
<span class="sd">            to trace what have we inserted</span>
<span class="sd">        </span>
<span class="sd">        Note:</span>
<span class="sd">            For documentation of the file format, refer to</span>
<span class="sd">            http://traffic.cit.api.here.com/traffic/6.0/xsd/flow.xsd?app_id=F8aPRXcW3MmyUvQ8Z3J9&amp;app_code=IVp1_zoGHdLdz0GvD_Eqsw</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1">## Testing purpose</span>
        <span class="k">if</span> <span class="n">testing</span><span class="p">:</span>  
            <span class="c1"># Notice you can ignore every lines under if testing:</span>
            <span class="c1"># codes under that block are for testing purposes</span>
            <span class="c1"># It&#39;s not really part of the core code</span>
            <span class="n">flow_item_duplicate</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="n">road_data_duplicate</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="n">roadflow_item_data_duplicate</span> <span class="o">=</span> <span class="mi">0</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">data</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;inserted nothing&#39;</span><span class="p">)</span>
            <span class="k">return</span> <span class="kc">None</span>

        <span class="c1">## insert the data into original_data table</span>
        <span class="n">created_timestamp</span> <span class="o">=</span> <span class="n">parser</span><span class="o">.</span><span class="n">parse</span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;CREATED_TIMESTAMP&#39;</span><span class="p">])</span>
        <span class="n">original_data_insertion</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s2">&quot;CREATED_TIMESTAMP&quot;</span><span class="p">:</span> <span class="n">r</span><span class="o">.</span><span class="n">expr</span><span class="p">(</span><span class="n">created_timestamp</span><span class="p">)</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">conn</span><span class="p">),</span>
            <span class="s2">&quot;crawled_batch_id&quot;</span><span class="p">:</span> <span class="n">crawled_batch_id</span><span class="p">,</span>
            <span class="s2">&quot;RWS&quot;</span><span class="p">:</span> <span class="n">data</span><span class="p">[</span><span class="s1">&#39;RWS&#39;</span><span class="p">]</span>
        <span class="p">}</span>
        <span class="n">insert_result</span> <span class="o">=</span> <span class="n">r</span><span class="o">.</span><span class="n">table</span><span class="p">(</span><span class="s1">&#39;original_data&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="n">original_data_insertion</span><span class="p">)</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">conn</span><span class="p">)</span>
        <span class="n">original_data_id</span> <span class="o">=</span> <span class="n">insert_result</span><span class="p">[</span><span class="s1">&#39;generated_keys&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>

        <span class="c1">## start parsing the data</span>
        <span class="k">for</span> <span class="n">RWS_item</span> <span class="ow">in</span> <span class="n">data</span><span class="p">[</span><span class="s1">&#39;RWS&#39;</span><span class="p">]:</span>
            <span class="k">for</span> <span class="n">RW_item</span> <span class="ow">in</span> <span class="n">RWS_item</span><span class="p">[</span><span class="s1">&#39;RW&#39;</span><span class="p">]:</span>
                <span class="k">for</span> <span class="n">FIS_item</span> <span class="ow">in</span> <span class="n">RW_item</span><span class="p">[</span><span class="s1">&#39;FIS&#39;</span><span class="p">]:</span>
                    <span class="k">for</span> <span class="n">FI_item</span> <span class="ow">in</span> <span class="n">FIS_item</span><span class="p">[</span><span class="s1">&#39;FI&#39;</span><span class="p">]:</span>
                        <span class="n">SHP_list</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">FI_item</span><span class="p">[</span><span class="s1">&#39;SHP&#39;</span><span class="p">])</span>
                        <span class="n">CF_item</span> <span class="o">=</span> <span class="n">FI_item</span><span class="p">[</span><span class="s1">&#39;CF&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
                        <span class="n">CF_item</span><span class="p">[</span><span class="s1">&#39;original_data_id&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">original_data_id</span>

                        <span class="c1">## we check if the flow_item alerady exist</span>
                        <span class="n">TMC_encoding</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="n">FI_item</span><span class="p">[</span><span class="s1">&#39;TMC&#39;</span><span class="p">],</span> <span class="n">sort_keys</span> <span class="o">=</span> <span class="kc">True</span><span class="p">)</span>  <span class="c1">## sort the key to elimincate different encoding of the same python Dict</span>
                        <span class="n">flow_item_doc</span> <span class="o">=</span> <span class="n">r</span><span class="o">.</span><span class="n">table</span><span class="p">(</span><span class="s1">&#39;flow_item&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">TMC_encoding</span><span class="p">)</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">conn</span><span class="p">)</span>

                        <span class="c1">## flow_item = None means the flow_item_doc does *not* exists</span>
                        <span class="k">if</span> <span class="ow">not</span> <span class="n">flow_item_doc</span><span class="p">:</span>
                            <span class="n">flow_item_insertion</span> <span class="o">=</span> <span class="p">{</span>
                                <span class="s2">&quot;flow_item_id&quot;</span><span class="p">:</span> <span class="n">TMC_encoding</span><span class="p">,</span>
                                <span class="s2">&quot;TMC&quot;</span><span class="p">:</span> <span class="n">FI_item</span><span class="p">[</span><span class="s1">&#39;TMC&#39;</span><span class="p">],</span>
                                <span class="s2">&quot;SHP&quot;</span><span class="p">:</span> <span class="s2">&quot;See table road_data&quot;</span><span class="p">,</span>
                                <span class="s2">&quot;CF&quot;</span><span class="p">:</span> <span class="s2">&quot;See table flow_data&quot;</span>
                            <span class="p">}</span>
                            <span class="c1"># flow_item_insertion[&quot;CF&quot;] = {crawled_batch_id: [CF_item]}   ## depreciated</span>
                            <span class="n">r</span><span class="o">.</span><span class="n">table</span><span class="p">(</span><span class="s1">&#39;flow_item&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="n">flow_item_insertion</span><span class="p">)</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">conn</span><span class="p">)</span>
                            <span class="n">flow_item_id</span> <span class="o">=</span> <span class="n">TMC_encoding</span>

                        <span class="c1">## if flow_item_doc already exist, we simply update the CF field</span>
                        <span class="k">else</span><span class="p">:</span>
                            <span class="n">flow_item_id</span> <span class="o">=</span> <span class="n">flow_item_doc</span><span class="p">[</span><span class="s1">&#39;flow_item_id&#39;</span><span class="p">]</span>
                            <span class="k">if</span> <span class="n">testing</span><span class="p">:</span>
                                <span class="n">flow_item_duplicate</span> <span class="o">+=</span> <span class="mi">1</span>

                        <span class="n">flow_data_insertion</span> <span class="o">=</span> <span class="p">{</span>
                            <span class="s2">&quot;crawled_batch_id&quot;</span><span class="p">:</span> <span class="n">crawled_batch_id</span><span class="p">,</span>
                            <span class="s2">&quot;flow_item_id&quot;</span><span class="p">:</span> <span class="n">flow_item_id</span><span class="p">,</span>
                            <span class="s2">&quot;created_timestamp&quot;</span><span class="p">:</span> <span class="n">r</span><span class="o">.</span><span class="n">expr</span><span class="p">(</span><span class="n">created_timestamp</span><span class="p">)</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">conn</span><span class="p">)</span>
                        <span class="p">}</span>
                        <span class="n">flow_data_insertion</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">CF_item</span><span class="p">)</span>  <span class="c1"># append CF_item</span>
                        <span class="n">r</span><span class="o">.</span><span class="n">table</span><span class="p">(</span><span class="s1">&#39;flow_data&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="n">flow_data_insertion</span><span class="p">)</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">conn</span><span class="p">)</span>
                        
                        <span class="k">for</span> <span class="n">SHP_item</span> <span class="ow">in</span> <span class="n">SHP_list</span><span class="p">:</span>
                            <span class="n">geometry_encoding</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="n">SHP_item</span><span class="p">[</span><span class="s1">&#39;value&#39;</span><span class="p">],</span> <span class="n">sort_keys</span><span class="o">=</span><span class="kc">True</span><span class="p">)[:</span><span class="mi">120</span><span class="p">]</span>  <span class="c1"># primary key&#39;s length is at most 127</span>
                            <span class="n">road_data_doc</span> <span class="o">=</span> <span class="n">r</span><span class="o">.</span><span class="n">table</span><span class="p">(</span><span class="s1">&#39;road_data&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">geometry_encoding</span><span class="p">)</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">conn</span><span class="p">)</span>

                            <span class="c1"># if road_data_doc does not exist, we insert the road into db. Notice that if road_data_doc exists, we simply ignore it.</span>
                            <span class="k">if</span> <span class="ow">not</span> <span class="n">road_data_doc</span><span class="p">:</span>
                                <span class="n">SHP_item</span><span class="p">[</span><span class="s1">&#39;flow_item_id&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">flow_item_id</span>
                                <span class="k">try</span><span class="p">:</span>
                                    <span class="n">SHP_item</span><span class="p">[</span><span class="s1">&#39;geometry&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">r</span><span class="o">.</span><span class="n">line</span><span class="p">(</span><span class="n">r</span><span class="o">.</span><span class="n">args</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">parse_SHP_values</span><span class="p">(</span><span class="n">SHP_item</span><span class="p">[</span><span class="s1">&#39;value&#39;</span><span class="p">])))</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">conn</span><span class="p">)</span>
                                    <span class="n">SHP_item</span><span class="p">[</span><span class="s1">&#39;road_data_id&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">geometry_encoding</span>
                                    <span class="n">r</span><span class="o">.</span><span class="n">table</span><span class="p">(</span><span class="s1">&#39;road_data&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="n">SHP_item</span><span class="p">)</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">conn</span><span class="p">)</span>
                                <span class="k">except</span><span class="p">:</span>
                                    <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s1">&#39;exception in parsing SHP values&#39;</span><span class="p">)</span>
                            <span class="k">else</span><span class="p">:</span>
                                <span class="c1"># maybe have different flow_item_id????</span>
                                <span class="k">if</span> <span class="n">testing</span><span class="p">:</span>
                                    <span class="n">road_data_duplicate</span> <span class="o">+=</span> <span class="mi">1</span>
                                    <span class="c1">## Notice it is possible for a road to point to different flow_item_id</span>
                                    <span class="c1">## comment out the following code to see what I mean.</span>
                                    <span class="c1"># if road_data_doc[&#39;flow_item_id&#39;] != flow_item_id:</span>
                                    <span class="c1">#     print(&quot;======================&quot;)</span>
                                    <span class="c1">#     print(road_data_doc[&#39;flow_item_id&#39;])</span>
                                    <span class="c1">#     print(flow_item_id)</span>

        <span class="k">if</span> <span class="n">testing</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;there are &#39;</span><span class="p">,</span><span class="n">flow_item_duplicate</span><span class="p">,</span> <span class="s1">&#39;flow_data duplicate&#39;</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;there are &#39;</span><span class="p">,</span><span class="n">road_data_duplicate</span><span class="p">,</span> <span class="s1">&#39;road_data duplicate&#39;</span><span class="p">)</span></div>


<div class="viewcode-block" id="TrafficData.parse_SHP_values"><a class="viewcode-back" href="../../streettraffic.html#streettraffic.database.TrafficData.parse_SHP_values">[docs]</a>    <span class="k">def</span> <span class="nf">parse_SHP_values</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">value</span><span class="p">:</span> <span class="n">List</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;This function convert the ``[&#39;SHP&#39;][&#39;values&#39;]`` of the JSON raw data into a list that </span>
<span class="sd">        conforms line specification of RethinkDB.</span>
<span class="sd">        </span>
<span class="sd">        More specifically, in RethinkDB every point has the **opposite** parameters: (long, lat) while our </span>
<span class="sd">        data has point (lat, long). For more details,</span>
<span class="sd">        refer to https://rethinkdb.com/api/python/line/ and https://rethinkdb.com/api/javascript/point/</span>

<span class="sd">        Args:</span>
<span class="sd">            value (List): the ``[&#39;SHP&#39;][&#39;values&#39;]`` of the JSON raw data</span>

<span class="sd">        Returns:</span>
<span class="sd">            List: a list of coordinates that is compliant with RethinkDB coordinates</span>
<span class="sd">            specification</span>

<span class="sd">        Examples:</span>
<span class="sd">            &gt;&gt;&gt; traffic_server = TrafficServer(database_name=&quot;Traffic&quot;, database_ip=&quot;localhost&quot;)</span>
<span class="sd">            &gt;&gt;&gt; traffic_server.traffic_data.parse_SHP_values([&quot;34.9495,-82.43912 34.94999,-82.4392 34.95139,-82.4394 &quot;])</span>
<span class="sd">            [[-82.43912, 34.9495], [-82.4392, 34.94999], [-82.4394, 34.95139]]</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">temp</span> <span class="o">=</span> <span class="n">value</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">()</span>
        <span class="n">result</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">temp</span><span class="p">:</span>
            <span class="n">item</span> <span class="o">=</span> <span class="n">item</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;,&#39;</span><span class="p">)</span>
            <span class="n">item</span> <span class="o">=</span> <span class="p">[</span><span class="nb">float</span><span class="p">(</span><span class="n">i</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">item</span><span class="p">]</span>
             <span class="c1"># we need to reverse the [lat, long] to [long, lat] to comply with</span>
             <span class="c1"># RethinkDB specifications at https://rethinkdb.com/api/javascript/point/</span>
            <span class="n">item</span><span class="o">.</span><span class="n">reverse</span><span class="p">()</span>
            <span class="n">result</span> <span class="o">+=</span> <span class="p">[</span><span class="n">item</span><span class="p">]</span>

        <span class="k">return</span> <span class="n">result</span></div>
    
<div class="viewcode-block" id="TrafficData.read_traffic_data"><a class="viewcode-back" href="../../streettraffic.html#streettraffic.database.TrafficData.read_traffic_data">[docs]</a>    <span class="k">def</span> <span class="nf">read_traffic_data</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">url</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;This functios takes the input url and return its json object</span>

<span class="sd">        Args:</span>
<span class="sd">            url (str): a url that has HERE traffic json file</span>

<span class="sd">        Returns:</span>
<span class="sd">            Dict: a parsed JSON file of the url</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">r</span> <span class="o">=</span> <span class="n">requests</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">url</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">r</span><span class="o">.</span><span class="n">status_code</span> <span class="o">==</span> <span class="mi">204</span><span class="p">:</span>  <span class="c1"># no content</span>
            <span class="k">return</span> <span class="kc">None</span>
        <span class="k">return</span> <span class="n">r</span><span class="o">.</span><span class="n">json</span><span class="p">()</span></div>

<div class="viewcode-block" id="TrafficData.helper_create_tables"><a class="viewcode-back" href="../../streettraffic.html#streettraffic.database.TrafficData.helper_create_tables">[docs]</a>    <span class="k">def</span> <span class="nf">helper_create_tables</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;This is a helper function to create default tables in rethinkDB</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1">## creating tables</span>
        <span class="n">r</span><span class="o">.</span><span class="n">table_create</span><span class="p">(</span><span class="s1">&#39;original_data&#39;</span><span class="p">,</span> <span class="n">primary_key</span> <span class="o">=</span><span class="s1">&#39;original_data_id&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">conn</span><span class="p">)</span>
        <span class="n">r</span><span class="o">.</span><span class="n">table_create</span><span class="p">(</span><span class="s1">&#39;road_data&#39;</span><span class="p">,</span> <span class="n">primary_key</span> <span class="o">=</span> <span class="s1">&#39;road_data_id&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">conn</span><span class="p">)</span>
        <span class="n">r</span><span class="o">.</span><span class="n">table_create</span><span class="p">(</span><span class="s1">&#39;flow_item&#39;</span><span class="p">,</span> <span class="n">primary_key</span> <span class="o">=</span> <span class="s1">&#39;flow_item_id&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">conn</span><span class="p">)</span>
        <span class="n">r</span><span class="o">.</span><span class="n">table_create</span><span class="p">(</span><span class="s1">&#39;crawled_batch&#39;</span><span class="p">,</span> <span class="n">primary_key</span> <span class="o">=</span> <span class="s1">&#39;crawled_batch_id&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">conn</span><span class="p">)</span>
        <span class="n">r</span><span class="o">.</span><span class="n">table_create</span><span class="p">(</span><span class="s1">&#39;flow_data&#39;</span><span class="p">,</span> <span class="n">primary_key</span> <span class="o">=</span> <span class="s1">&#39;flow_data_id&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">conn</span><span class="p">)</span>
        <span class="n">r</span><span class="o">.</span><span class="n">table_create</span><span class="p">(</span><span class="s1">&#39;route_cached&#39;</span><span class="p">,</span> <span class="n">primary_key</span> <span class="o">=</span> <span class="s1">&#39;route_cached_id&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">conn</span><span class="p">)</span>
        <span class="n">r</span><span class="o">.</span><span class="n">table_create</span><span class="p">(</span><span class="s1">&#39;analytics_monitored_area&#39;</span><span class="p">,</span> <span class="n">primary_key</span> <span class="o">=</span> <span class="s1">&#39;analytics_monitored_area_id&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">conn</span><span class="p">)</span>
        <span class="n">r</span><span class="o">.</span><span class="n">table_create</span><span class="p">(</span><span class="s1">&#39;analytics_traffic_pattern&#39;</span><span class="p">,</span> <span class="n">primary_key</span> <span class="o">=</span> <span class="s1">&#39;analytics_traffic_pattern_id&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">conn</span><span class="p">)</span>

        <span class="c1">## creating index</span>
        <span class="n">r</span><span class="o">.</span><span class="n">table</span><span class="p">(</span><span class="s1">&#39;road_data&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">index_create</span><span class="p">(</span><span class="s1">&#39;flow_item_id&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">conn</span><span class="p">)</span>
        <span class="n">r</span><span class="o">.</span><span class="n">table</span><span class="p">(</span><span class="s1">&#39;road_data&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">index_create</span><span class="p">(</span><span class="s1">&#39;geometry&#39;</span><span class="p">,</span> <span class="n">geo</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">conn</span><span class="p">)</span>
        <span class="n">r</span><span class="o">.</span><span class="n">table</span><span class="p">(</span><span class="s1">&#39;crawled_batch&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">index_create</span><span class="p">(</span><span class="s1">&#39;crawled_timestamp&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">conn</span><span class="p">)</span>
        <span class="n">r</span><span class="o">.</span><span class="n">table</span><span class="p">(</span><span class="s2">&quot;flow_data&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">index_create</span><span class="p">(</span><span class="s2">&quot;flow_crawled_batch&quot;</span><span class="p">,</span> <span class="p">[</span><span class="n">r</span><span class="o">.</span><span class="n">row</span><span class="p">[</span><span class="s2">&quot;flow_item_id&quot;</span><span class="p">],</span> <span class="n">r</span><span class="o">.</span><span class="n">row</span><span class="p">[</span><span class="s2">&quot;crawled_batch_id&quot;</span><span class="p">]])</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">conn</span><span class="p">)</span>
        <span class="n">r</span><span class="o">.</span><span class="n">table</span><span class="p">(</span><span class="s1">&#39;analytics_monitored_area&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">index_create</span><span class="p">(</span><span class="s1">&#39;description&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">conn</span><span class="p">)</span>
        <span class="n">r</span><span class="o">.</span><span class="n">table</span><span class="p">(</span><span class="s2">&quot;analytics_traffic_pattern&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">index_create</span><span class="p">(</span><span class="s2">&quot;analytics_crawled_batch&quot;</span><span class="p">,</span> <span class="p">[</span><span class="n">r</span><span class="o">.</span><span class="n">row</span><span class="p">[</span><span class="s2">&quot;analytics_monitored_area_id&quot;</span><span class="p">],</span> <span class="n">r</span><span class="o">.</span><span class="n">row</span><span class="p">[</span><span class="s2">&quot;crawled_batch_id&quot;</span><span class="p">]])</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">conn</span><span class="p">)</span></div>

        <span class="c1">## depreciated index</span>
        <span class="c1"># r.table(&#39;flow_data&#39;).index_create(&#39;created_timestamp&#39;, r.row[&quot;CUSTOM&quot;][&quot;created_timestamp&quot;]).run(self.conn)</span>
        <span class="c1"># r.table(&#39;road_data&#39;).index_create(&#39;created_timestamp&#39;).run(self.conn)</span>
        <span class="c1"># r.table(&#39;road_data&#39;).index_create(&#39;crawled_batch_id&#39;).run(self.conn)</span>
        <span class="c1"># r.table(&#39;flow_data&#39;).index_create(&#39;crawled_batch_id&#39;, r.row[&quot;CUSTOM&quot;][&quot;crawled_batch_id&quot;]).run(self.conn)</span>
        <span class="c1"># r.table(&#39;flow_data&#39;).index_create(&#39;original_data_id&#39;, r.row[&quot;CUSTOM&quot;][&quot;original_data_id&quot;]).run(self.conn)</span>
        <span class="c1"># r.table(&#39;original_data&#39;).index_create(&#39;crawled_batch_id&#39;).run(self.conn)</span>
        <span class="c1">#r.table(&#39;original_data&#39;).index_create(&#39;crawled_batch_id&#39;).run(self.conn)</span>

<div class="viewcode-block" id="TrafficData.store_matrix_json"><a class="viewcode-back" href="../../streettraffic.html#streettraffic.database.TrafficData.store_matrix_json">[docs]</a>    <span class="k">def</span> <span class="nf">store_matrix_json</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">matrix_list</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;This function takes the matrix, download all the jsons in the matrix, store them in </span>
<span class="sd">        the database</span>

<span class="sd">        Args:</span>
<span class="sd">            matrix_list (pd.DataFrame): a matrix of urls of json traffic information generated </span>
<span class="sd">                by ``Utility.get_area_tile_matrix_url()``</span>

<span class="sd">        Returns:</span>
<span class="sd">            None</span>

<span class="sd">        Examples:</span>
<span class="sd">            &gt;&gt;&gt; df</span>
<span class="sd">                                                               0  \\</span>
<span class="sd">            0  https://traffic.cit.api.here.com/traffic/6.2/f...   </span>
<span class="sd">            1  https://traffic.cit.api.here.com/traffic/6.2/f...   </span>
<span class="sd">            2  https://traffic.cit.api.here.com/traffic/6.2/f...   </span>
<span class="sd">                                                               1  \\</span>
<span class="sd">            0  https://traffic.cit.api.here.com/traffic/6.2/f...   </span>
<span class="sd">            1  https://traffic.cit.api.here.com/traffic/6.2/f...   </span>
<span class="sd">            2  https://traffic.cit.api.here.com/traffic/6.2/f...   </span>
<span class="sd">                                                               2  </span>
<span class="sd">            0  https://traffic.cit.api.here.com/traffic/6.2/f...  </span>
<span class="sd">            1  https://traffic.cit.api.here.com/traffic/6.2/f...  </span>
<span class="sd">            2  https://traffic.cit.api.here.com/traffic/6.2/f...  </span>
<span class="sd">            &gt;&gt;&gt; # this df is an example input</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># store info about matrix_list and when do we crawled them</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">matrix_list</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;matrix_list has no element&#39;</span><span class="p">)</span>
            <span class="k">return</span>
        <span class="n">crawled_epochtime</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
        <span class="n">storing_dict</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="n">storing_dict</span><span class="p">[</span><span class="s1">&#39;crawled_timestamp&#39;</span><span class="p">]</span> <span class="o">=</span>  <span class="n">r</span><span class="o">.</span><span class="n">epoch_time</span><span class="p">(</span><span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">())</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">conn</span><span class="p">)</span>
        <span class="n">matrix_list_encoding</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">matrix</span> <span class="ow">in</span> <span class="n">matrix_list</span><span class="p">:</span>
            <span class="n">matrix_list_encoding</span> <span class="o">+=</span> <span class="p">[</span><span class="n">json</span><span class="o">.</span><span class="n">loads</span><span class="p">(</span><span class="n">matrix</span><span class="o">.</span><span class="n">to_json</span><span class="p">(</span><span class="n">orient</span><span class="o">=</span><span class="s1">&#39;table&#39;</span><span class="p">))]</span>
        <span class="n">storing_dict</span><span class="p">[</span><span class="s1">&#39;crawled_matrix_encoding&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">matrix_list_encoding</span>
        <span class="c1"># notice you can reverse the encoding, refer to </span>
        <span class="c1"># https://pandas.pydata.org/pandas-docs/stable/generated/pandas.DataFrame.to_json.html</span>
        <span class="n">insert_result</span> <span class="o">=</span> <span class="n">r</span><span class="o">.</span><span class="n">table</span><span class="p">(</span><span class="s1">&#39;crawled_batch&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="n">storing_dict</span><span class="p">)</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">conn</span><span class="p">)</span>
        <span class="n">crawled_batch_id</span> <span class="o">=</span> <span class="n">insert_result</span><span class="p">[</span><span class="s1">&#39;generated_keys&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>

        <span class="c1"># start inserting actual data</span>
        <span class="k">for</span> <span class="n">matrix</span> <span class="ow">in</span> <span class="n">matrix_list</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">matrix</span><span class="p">)):</span>
                <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">matrix</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="mi">0</span><span class="p">])):</span>
                    <span class="k">if</span> <span class="n">matrix</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">]:</span>
                        <span class="k">try</span><span class="p">:</span>
                            <span class="n">traffic_data</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">read_traffic_data</span><span class="p">(</span><span class="n">matrix</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">])</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">insert_json_data</span><span class="p">(</span><span class="n">traffic_data</span><span class="p">,</span> <span class="n">crawled_batch_id</span><span class="p">)</span>
                            <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mf">0.5</span><span class="p">)</span>
                        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;store_matrix_json&#39;</span><span class="p">,</span> <span class="n">e</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">latest_crawled_batch_id</span> <span class="o">=</span> <span class="n">r</span><span class="o">.</span><span class="n">table</span><span class="p">(</span><span class="s1">&#39;crawled_batch&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">order_by</span><span class="p">(</span><span class="n">index</span> <span class="o">=</span> <span class="n">r</span><span class="o">.</span><span class="n">desc</span><span class="p">(</span><span class="s2">&quot;crawled_timestamp&quot;</span><span class="p">))</span><span class="o">.</span><span class="n">limit</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">conn</span><span class="p">)</span><span class="o">.</span><span class="n">next</span><span class="p">()[</span><span class="s1">&#39;crawled_batch_id&#39;</span><span class="p">]</span></div>

<div class="viewcode-block" id="TrafficData.fetch_geojson_item"><a class="viewcode-back" href="../../streettraffic.html#streettraffic.database.TrafficData.fetch_geojson_item">[docs]</a>    <span class="k">def</span> <span class="nf">fetch_geojson_item</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">road_data_id</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">crawled_batch_id</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">calculate_traffic_color</span> <span class="o">=</span> <span class="kc">True</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;This function uses a road_data_id(primary key) to fethe a geojson object from </span>
<span class="sd">        the road_data database. If calculate_traffic_color == True, then we also use</span>
<span class="sd">        traffic_flow_color_scheme() to calcuroad_data_idlate a color for the road</span>

<span class="sd">        For more infomation about geojson, check out</span>
<span class="sd">        http://geojson.org/</span>

<span class="sd">        Args:</span>
<span class="sd">            road_data_id (str): the primary key of table ``road_data``</span>
<span class="sd">            crawled_batch_id (str): the primary key of table ``crawled_batch``, if crawled_batch_id is ``None``,</span>
<span class="sd">                the default setting, then it will be initlized to be the same as </span>
<span class="sd">                ``self.latest_crawled_batch_id``</span>
<span class="sd">            calculate_traffic_color (bool): whether you want to have a color attribute attached to your geojson</span>
<span class="sd">                object. The color is calculated by ``self.traffic_flow_color_scheme()``</span>

<span class="sd">        Returns:</span>
<span class="sd">            Dict: a geojson object, see the example below.</span>

<span class="sd">        Examples:</span>
<span class="sd">            &gt;&gt;&gt; traffic_server = TrafficServer(database_name=&quot;Traffic&quot;, database_ip=&quot;localhost&quot;)</span>
<span class="sd">            &gt;&gt;&gt; traffic_server.traffic_data.fetch_geojson_item(&#39;[&quot;34.85075,-82.39899 34.85154,-82.39863 &quot;]&#39;, </span>
<span class="sd">                    &#39;44b57efd-8b63-4c49-8c86-9e92f79f528a&#39;, True)</span>
<span class="sd">            {&#39;geometry&#39;: {&#39;coordinates&#39;: [[-82.39899, 34.85075], [-82.39863, 34.85154]],</span>
<span class="sd">             &#39;type&#39;: &#39;LineString&#39;},</span>
<span class="sd">            &#39;properties&#39;: {&#39;CF&#39;: {&#39;CN&#39;: 0.7,</span>
<span class="sd">              &#39;FF&#39;: 10.56,</span>
<span class="sd">              &#39;JF&#39;: 0,</span>
<span class="sd">              &#39;LN&#39;: [],</span>
<span class="sd">              &#39;SP&#39;: 8.7,</span>
<span class="sd">              &#39;SU&#39;: 8.7,</span>
<span class="sd">              &#39;TY&#39;: &#39;TR&#39;,</span>
<span class="sd">              &#39;crawled_batch_id&#39;: &#39;44b57efd-8b63-4c49-8c86-9e92f79f528a&#39;,</span>
<span class="sd">              &#39;created_timestamp&#39;: &#39;2017-07-14T05:06:39+00:00&#39;,</span>
<span class="sd">              &#39;flow_data_id&#39;: &#39;337cb755-8eb9-4808-94c9-29e422bc3e32&#39;,</span>
<span class="sd">              &#39;flow_item_id&#39;: &#39;{&quot;DE&quot;: &quot;SC-183/Beattie Pl/College St&quot;, &quot;LE&quot;: 0.64899, &quot;PC&quot;: 11029, &quot;QD&quot;: &quot;-&quot;}&#39;,</span>
<span class="sd">              &#39;original_data_id&#39;: &#39;1a84e269-2070-4697-b75b-1349edcb7bbb&#39;},</span>
<span class="sd">             &#39;TMC&#39;: {&#39;DE&#39;: &#39;SC-183/Beattie Pl/College St&#39;,</span>
<span class="sd">              &#39;LE&#39;: 0.64899,</span>
<span class="sd">              &#39;PC&#39;: 11029,</span>
<span class="sd">              &#39;QD&#39;: &#39;-&#39;},</span>
<span class="sd">             &#39;color&#39;: &#39;green&#39;},</span>
<span class="sd">            &#39;type&#39;: &#39;Feature&#39;}</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">crawled_batch_id</span><span class="p">:</span>
            <span class="n">crawled_batch_id</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">latest_crawled_batch_id</span>
        <span class="n">data</span> <span class="o">=</span> <span class="n">r</span><span class="o">.</span><span class="n">table</span><span class="p">(</span><span class="s1">&#39;road_data&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">road_data_id</span><span class="p">)</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">conn</span><span class="p">)</span>
        <span class="n">flow_item_id</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="s1">&#39;flow_item_id&#39;</span><span class="p">]</span>
        <span class="n">flow_item</span> <span class="o">=</span> <span class="n">r</span><span class="o">.</span><span class="n">table</span><span class="p">(</span><span class="s1">&#39;flow_item&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">flow_item_id</span><span class="p">)</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">conn</span><span class="p">)</span>
        <span class="n">flow_data</span> <span class="o">=</span> <span class="n">r</span><span class="o">.</span><span class="n">table</span><span class="p">(</span><span class="s1">&#39;flow_data&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">get_all</span><span class="p">([</span><span class="n">flow_item_id</span><span class="p">,</span> <span class="n">crawled_batch_id</span><span class="p">],</span> <span class="n">index</span> <span class="o">=</span> <span class="s2">&quot;flow_crawled_batch&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">limit</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">conn</span><span class="p">)</span><span class="o">.</span><span class="n">next</span><span class="p">()</span>
        <span class="nb">print</span><span class="p">(</span><span class="n">road_data_id</span><span class="p">,</span> <span class="n">crawled_batch_id</span><span class="p">)</span>

        <span class="n">flow_data</span><span class="p">[</span><span class="s1">&#39;created_timestamp&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">flow_data</span><span class="p">[</span><span class="s1">&#39;created_timestamp&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">isoformat</span><span class="p">()</span>
        <span class="n">geojson_properties</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;TMC&#39;</span><span class="p">:</span> <span class="n">flow_item</span><span class="p">[</span><span class="s1">&#39;TMC&#39;</span><span class="p">],</span> <span class="s1">&#39;CF&#39;</span><span class="p">:</span> <span class="n">flow_data</span><span class="p">}</span>
        
        <span class="k">if</span> <span class="n">calculate_traffic_color</span><span class="p">:</span>
            <span class="n">geojson_properties</span><span class="p">[</span><span class="s1">&#39;color&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">traffic_flow_color_scheme</span><span class="p">(</span><span class="n">geojson_properties</span><span class="p">[</span><span class="s1">&#39;CF&#39;</span><span class="p">])</span>

        <span class="n">geojson_geometry</span> <span class="o">=</span> <span class="n">r</span><span class="o">.</span><span class="n">table</span><span class="p">(</span><span class="s1">&#39;road_data&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">road_data_id</span><span class="p">)[</span><span class="s1">&#39;geometry&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">to_geojson</span><span class="p">()</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">conn</span><span class="p">)</span>
        <span class="n">geojson_type</span> <span class="o">=</span> <span class="s2">&quot;Feature&quot;</span>

        <span class="k">return</span> <span class="p">{</span><span class="s2">&quot;type&quot;</span><span class="p">:</span> <span class="n">geojson_type</span><span class="p">,</span> <span class="s2">&quot;geometry&quot;</span><span class="p">:</span> <span class="n">geojson_geometry</span><span class="p">,</span> <span class="s2">&quot;properties&quot;</span><span class="p">:</span> <span class="n">geojson_properties</span><span class="p">}</span></div>

    <span class="nd">@staticmethod</span>
<div class="viewcode-block" id="TrafficData.generate_geojson_collection"><a class="viewcode-back" href="../../streettraffic.html#streettraffic.database.TrafficData.generate_geojson_collection">[docs]</a>    <span class="k">def</span> <span class="nf">generate_geojson_collection</span><span class="p">(</span><span class="n">geojson_list</span><span class="p">:</span> <span class="n">List</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;This function takes a list of geojson objects and assemble them in the following way</span>
<span class="sd">        The following format allows for multiple geojson object to be stored in the </span>
<span class="sd">        same geojson object. For more details, refer to </span>
<span class="sd">        https://macwright.org/2015/03/23/geojson-second-bite.html</span>

<span class="sd">        Args:</span>
<span class="sd">            geojson_list (List): a list of geojson objects generated by </span>
<span class="sd">                ``self.fetch_geojson_item()``</span>

<span class="sd">        Returns:</span>
<span class="sd">            Dict: a valid geojson object that contains all the </span>
<span class="sd">            geojson object in geojson_list</span>

<span class="sd">        Examples:</span>
<span class="sd">            &gt;&gt;&gt; traffic_server = TrafficServer(database_name=&quot;Traffic&quot;, database_ip=&quot;localhost&quot;)</span>
<span class="sd">            &gt;&gt;&gt; input_list</span>
<span class="sd">            [{</span>
<span class="sd">              &quot;type&quot;: &quot;Feature&quot;,</span>
<span class="sd">              &quot;geometry&quot;: {</span>
<span class="sd">                &quot;type&quot;: &quot;Point&quot;,</span>
<span class="sd">                &quot;coordinates&quot;: [125.6, 10.1]</span>
<span class="sd">              },</span>
<span class="sd">              &quot;properties&quot;: {</span>
<span class="sd">                &quot;name&quot;: &quot;Dinagat Islands&quot;</span>
<span class="sd">              }</span>
<span class="sd">            },</span>
<span class="sd">            {</span>
<span class="sd">              &quot;type&quot;: &quot;Feature&quot;,</span>
<span class="sd">              &quot;geometry&quot;: {</span>
<span class="sd">                &quot;type&quot;: &quot;Point&quot;,</span>
<span class="sd">                &quot;coordinates&quot;: [15,15]</span>
<span class="sd">              },</span>
<span class="sd">              &quot;properties&quot;: {</span>
<span class="sd">                &quot;name&quot;: &quot;Test Islands&quot;</span>
<span class="sd">              }</span>
<span class="sd">            }]  # notice the ... just mean more of those geojson object</span>
<span class="sd">            &gt;&gt;&gt; traffic_server.traffic_data.generate_geojson_collection(input_list)</span>
<span class="sd">            {</span>
<span class="sd">              &quot;type&quot;: &quot;FeatureCollection&quot;,</span>
<span class="sd">              &quot;features&quot;: [</span>
<span class="sd">                {</span>
<span class="sd">                  &quot;type&quot;: &quot;Feature&quot;,</span>
<span class="sd">                  &quot;geometry&quot;: {</span>
<span class="sd">                    &quot;type&quot;: &quot;Point&quot;,</span>
<span class="sd">                    &quot;coordinates&quot;: [125.6, 10.1]</span>
<span class="sd">                  },</span>
<span class="sd">                  &quot;properties&quot;: {</span>
<span class="sd">                    &quot;name&quot;: &quot;Dinagat island&quot;</span>
<span class="sd">                  }</span>
<span class="sd">                },</span>
<span class="sd">                {</span>
<span class="sd">                  &quot;type&quot;: &quot;Feature&quot;,</span>
<span class="sd">                  &quot;geometry&quot;: {</span>
<span class="sd">                    &quot;type&quot;: &quot;Point&quot;,</span>
<span class="sd">                    &quot;coordinates&quot;: [15,15]</span>
<span class="sd">                  },</span>
<span class="sd">                  &quot;properties&quot;: {</span>
<span class="sd">                    &quot;name&quot;: &quot;Test Islands&quot;</span>
<span class="sd">                  }</span>
<span class="sd">                }</span>
<span class="sd">              ]</span>
<span class="sd">            }</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">output_geojson</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;type&quot;</span><span class="p">:</span> <span class="s2">&quot;FeatureCollection&quot;</span><span class="p">}</span>
        <span class="n">output_geojson</span><span class="p">[</span><span class="s1">&#39;features&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">geojson_list</span>
        <span class="k">return</span> <span class="n">output_geojson</span></div>

<div class="viewcode-block" id="TrafficData.traffic_flow_color_scheme"><a class="viewcode-back" href="../../streettraffic.html#streettraffic.database.TrafficData.traffic_flow_color_scheme">[docs]</a>    <span class="k">def</span> <span class="nf">traffic_flow_color_scheme</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">traffic_flow_data</span><span class="p">:</span> <span class="n">Dict</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span> 
        <span class="sd">&quot;&quot;&quot;Given the traffic_flow_data, we calculate a color that indicates the traffic situation of the road</span>
<span class="sd">        </span>
<span class="sd">        for further details on those encoding, refer to </span>
<span class="sd">        http://traffic.cit.api.here.com/traffic/6.0/xsd/flow.xsd?app_id=F8aPRXcW3MmyUvQ8Z3J9&amp;app_code=IVp1_zoGHdLdz0GvD_Eqsw</span>

<span class="sd">        Check out the following link for coloring Map</span>
<span class="sd">        https://developer.here.com/rest-apis/documentation/traffic/topics/tiles.html</span>

<span class="sd">        Args:</span>
<span class="sd">            traffic_flow_data (Dict): traffic flow data</span>

<span class="sd">        Returns:</span>
<span class="sd">            str: a color</span>

<span class="sd">        Examples:</span>
<span class="sd">            &gt;&gt;&gt; traffic_server = TrafficServer(database_name=&quot;Traffic&quot;, database_ip=&quot;localhost&quot;)</span>
<span class="sd">            &gt;&gt;&gt; traffic_flow_data</span>
<span class="sd">            {</span>
<span class="sd">                &quot;CN&quot;: 0.7 ,  # Confidence, an indication of how the speed was determined. -1.0 road closed. 1.0=100% 0.7-100% Historical Usually a value between .7 and 1.0.</span>
<span class="sd">                &quot;FF&quot;: 41.01 , # The free flow speed on this stretch of road.</span>
<span class="sd">                &quot;JF&quot;: 1.89393 , # The number between 0.0 and 10.0 indicating the expected quality of travel. When there is a road closure, the Jam Factor will be 10. As the number approaches 10.0 the quality of travel is getting worse. -1.0 indicates that a Jam Factor could not be calculated.</span>
<span class="sd">                &quot;LN&quot;: [ ],</span>
<span class="sd">                &quot;SP&quot;: 31.69 , # Speed (based on UNITS) capped by speed limit MPH</span>
<span class="sd">                &quot;SU&quot;: 31.69 , # Speed (based on UNITS) not capped by speed limit</span>
<span class="sd">                &quot;TY&quot;:  &quot;TR&quot;   # Used when it is needed to differentiate between different kinds of location types.</span>
<span class="sd">            }</span>
<span class="sd">            &gt;&gt;&gt; traffic_server.traffic_data.traffic_flow_color_scheme(traffic_flow_data)</span>
<span class="sd">            &#39;green&#39;</span>
<span class="sd">        &quot;&quot;&quot;</span>
        
        <span class="c1">## right now we just simply write a temporary fix</span>
        <span class="k">if</span> <span class="n">traffic_flow_data</span><span class="p">[</span><span class="s1">&#39;JF&#39;</span><span class="p">]</span> <span class="o">&lt;</span> <span class="mi">4</span><span class="p">:</span>
            <span class="k">return</span> <span class="s1">&#39;green&#39;</span>  <span class="c1"># #55ce37 it also has hash value color support</span>
        <span class="k">elif</span> <span class="n">traffic_flow_data</span><span class="p">[</span><span class="s1">&#39;JF&#39;</span><span class="p">]</span> <span class="o">&gt;=</span> <span class="mi">4</span> <span class="ow">and</span> <span class="n">traffic_flow_data</span><span class="p">[</span><span class="s1">&#39;JF&#39;</span><span class="p">]</span> <span class="o">&lt;</span> <span class="mi">8</span><span class="p">:</span>
            <span class="k">return</span> <span class="s1">&#39;yellow&#39;</span>
        <span class="k">elif</span> <span class="n">traffic_flow_data</span><span class="p">[</span><span class="s1">&#39;JF&#39;</span><span class="p">]</span> <span class="o">&gt;=</span> <span class="mi">8</span> <span class="ow">and</span> <span class="n">traffic_flow_data</span><span class="p">[</span><span class="s1">&#39;JF&#39;</span><span class="p">]</span> <span class="o">&lt;</span> <span class="mi">10</span><span class="p">:</span>
            <span class="k">return</span> <span class="s1">&#39;red&#39;</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="s1">&#39;black&#39;</span></div>

<div class="viewcode-block" id="TrafficData.get_nearest_road"><a class="viewcode-back" href="../../streettraffic.html#streettraffic.database.TrafficData.get_nearest_road">[docs]</a>    <span class="k">def</span> <span class="nf">get_nearest_road</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">location_data</span><span class="p">:</span> <span class="nb">tuple</span><span class="p">,</span> <span class="n">max_dist</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">max_results</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span> <span class="n">location_type</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;latlon&quot;</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;This function finds the nearest document of ``road_data`` table with</span>
<span class="sd">        respect to your queried location</span>
<span class="sd">        </span>
<span class="sd">        Args:</span>
<span class="sd">            location_data (tuple): for now we only support (latitude: float, longitude: float)</span>
<span class="sd">            max_dist (int): maximal distance query range for your input point</span>
<span class="sd">            max_results (int): the maximum result of your query. Default is set to ``1``. </span>
<span class="sd">                Notice Currently this doesn&#39;t mean anything since we always return the only nearest, </span>
<span class="sd">                in the future, we might support returning more couple nearest roads.</span>
<span class="sd">            location_type (str): the location_data type. Default is set to ``&quot;latlon&quot;``</span>

<span class="sd">        Returns:</span>
<span class="sd">            str: a color</span>

<span class="sd">        Examples:</span>
<span class="sd">            &gt;&gt;&gt; traffic_server = TrafficServer(database_name=&quot;Traffic&quot;, database_ip=&quot;localhost&quot;)</span>
<span class="sd">            &gt;&gt;&gt; location_data = (33.76895, -84.37777)</span>
<span class="sd">            &gt;&gt;&gt; traffic_server.traffic_data.get_nearest_road(location_data, 1000)</span>
<span class="sd">            {&#39;dist&#39;: 0.638734341680409,</span>
<span class="sd">            &#39;doc&#39;: {&#39;FC&#39;: 4,</span>
<span class="sd">             &#39;flow_item_id&#39;: &#39;{&quot;DE&quot;: &quot;US-278/US-29/Ponce De Leon Ave NE&quot;, &quot;LE&quot;: 0.58406, &quot;PC&quot;: 12873, &quot;QD&quot;: &quot;-&quot;}&#39;,</span>
<span class="sd">             &#39;geometry&#39;: {&#39;$reql_type$&#39;: &#39;GEOMETRY&#39;,</span>
<span class="sd">              &#39;coordinates&#39;: [[-84.37777, 33.76865],</span>
<span class="sd">               [-84.37775, 33.76952],</span>
<span class="sd">               [-84.37774, 33.76994]],</span>
<span class="sd">              &#39;type&#39;: &#39;LineString&#39;},</span>
<span class="sd">             &#39;road_data_id&#39;: &#39;[&quot;33.76865,-84.37777 33.76952,-84.37775 33.76994,-84.37774 &quot;]&#39;,</span>
<span class="sd">             &#39;value&#39;: [&#39;33.76865,-84.37777 33.76952,-84.37775 33.76994,-84.37774 &#39;]}}</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">query_result</span> <span class="o">=</span> <span class="n">r</span><span class="o">.</span><span class="n">table</span><span class="p">(</span><span class="s1">&#39;road_data&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">get_nearest</span><span class="p">(</span><span class="n">r</span><span class="o">.</span><span class="n">point</span><span class="p">(</span><span class="n">location_data</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span><span class="n">location_data</span><span class="p">[</span><span class="mi">0</span><span class="p">]),</span> <span class="n">index</span> <span class="o">=</span> <span class="s1">&#39;geometry&#39;</span><span class="p">,</span>
                                                        <span class="n">max_dist</span> <span class="o">=</span> <span class="n">max_dist</span><span class="p">,</span> <span class="n">max_results</span> <span class="o">=</span> <span class="n">max_results</span><span class="p">)</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">conn</span><span class="p">)</span>  <span class="c1"># Probably not very efficient</span>

        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">query_result</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s1">&#39;query_result has no results&#39;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">query_result</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span></div>

<div class="viewcode-block" id="TrafficData.get_historic_traffic"><a class="viewcode-back" href="../../streettraffic.html#streettraffic.database.TrafficData.get_historic_traffic">[docs]</a>    <span class="k">def</span> <span class="nf">get_historic_traffic</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">routing_info</span><span class="p">:</span> <span class="n">Dict</span><span class="p">,</span> <span class="n">use_overview</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span> <span class="n">crawled_batch_id</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;This function generate a geojson object that includes all the traffic flow</span>
<span class="sd">        data with respect to your selected routing_info and crawled_batch_id</span>

<span class="sd">        Args:</span>
<span class="sd">            routing_info (Dict): the routing JSON object from Google Javascript Direction API</span>
<span class="sd">            use_overview (bool): whether to use ``route[&#39;overview_polyline&#39;]`` to build ``route_cached_doc``.</span>
<span class="sd">                If set to be True, the execution will be generally faster, but you will have less coordiantes</span>
<span class="sd">                in your route_cached_doc.</span>
<span class="sd">            crawled_batch_id (str): the primary key of table ``crawled_batch``, if crawled_batch_id is ``None``,</span>
<span class="sd">                the default setting, then it will be initlized to be the same as </span>
<span class="sd">                ``self.latest_crawled_batch_id``</span>

<span class="sd">        Returns:</span>
<span class="sd">            Dict: a geojson object that uses ``FeatureCollection`` to contain multiple geojson object</span>
<span class="sd">            related to the routing</span>

<span class="sd">        Todo:</span>
<span class="sd">            * maybe use async to speed up performance</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">crawled_batch_id</span><span class="p">:</span>
            <span class="n">crawled_batch_id</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">latest_crawled_batch_id</span>
        <span class="c1">## there might be multiple **routes**, but we just worry about one for now</span>
        <span class="n">route</span> <span class="o">=</span> <span class="n">routing_info</span><span class="p">[</span><span class="s1">&#39;routes&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>

        <span class="c1">## We first check if someone has already used this route before, and we use overview_polyline as an identifier</span>
        <span class="n">route_cached_id</span> <span class="o">=</span> <span class="n">route</span><span class="p">[</span><span class="s1">&#39;overview_polyline&#39;</span><span class="p">][:</span><span class="mi">120</span><span class="p">]</span>  <span class="c1"># primary key&#39;s length is at most 127</span>
        <span class="n">route_cached_doc</span> <span class="o">=</span> <span class="n">r</span><span class="o">.</span><span class="n">table</span><span class="p">(</span><span class="s1">&#39;route_cached&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">route_cached_id</span><span class="p">)</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">conn</span><span class="p">)</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">route_cached_doc</span><span class="p">:</span>
            <span class="c1">## if we haven&#39;t cache this route before, we need to store it in route_cached</span>
            <span class="c1">## we don&#39;t want duplicate road in our collection</span>
            <span class="n">road_id_collection</span> <span class="o">=</span> <span class="p">{}</span>
            <span class="n">duplicate_road_id</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="n">geojson_road_id_collection</span> <span class="o">=</span> <span class="p">[]</span>

            <span class="k">if</span> <span class="n">use_overview</span><span class="p">:</span>
            <span class="c1">#     ## use overview to optimize query time</span>
            <span class="c1">#     for overview_path_item in route[&#39;overview_path&#39;]:</span>
            <span class="c1">#         try:</span>
            <span class="c1">#             road_document = self.get_nearest_road((overview_path_item[&#39;lat&#39;], overview_path_item[&#39;lng&#39;]), max_dist = 1000)</span>
            <span class="c1">#             road_data_id = road_document[&#39;doc&#39;][&#39;road_data_id&#39;]</span>
            <span class="c1">#         except:</span>
            <span class="c1">#             print(&#39;cant find nearest road once&#39;)</span>

            <span class="c1">#         ## see if road_data_id already exists in our collection</span>
            <span class="c1">#         if road_data_id not in road_id_collection:</span>
            <span class="c1">#             road_id_collection[road_data_id] = True</span>
            <span class="c1">#             geojson_road_id_collection += [road_data_id]</span>
            <span class="c1">#         else:</span>
            <span class="c1">#             duplicate_road_id += [road_data_id]</span>


            <span class="c1"># else:</span>
            <span class="c1">#     ## we could also query every point in our path, but the query performance is slow</span>
            <span class="c1">#     ## there might be multiple **legs**, but we just worry about one for now</span>
                <span class="n">leg</span> <span class="o">=</span> <span class="n">route</span><span class="p">[</span><span class="s1">&#39;legs&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
                <span class="k">for</span> <span class="n">step</span> <span class="ow">in</span> <span class="n">leg</span><span class="p">[</span><span class="s1">&#39;steps&#39;</span><span class="p">]:</span>
                    <span class="k">for</span> <span class="n">path_item</span> <span class="ow">in</span> <span class="n">step</span><span class="p">[</span><span class="s1">&#39;path&#39;</span><span class="p">]:</span>
                        <span class="k">try</span><span class="p">:</span>
                            <span class="n">road_document</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_nearest_road</span><span class="p">((</span><span class="n">path_item</span><span class="p">[</span><span class="s1">&#39;lat&#39;</span><span class="p">],</span> <span class="n">path_item</span><span class="p">[</span><span class="s1">&#39;lng&#39;</span><span class="p">]),</span> <span class="n">max_dist</span> <span class="o">=</span> <span class="mi">1000</span><span class="p">)</span>
                            <span class="n">road_data_id</span> <span class="o">=</span> <span class="n">road_document</span><span class="p">[</span><span class="s1">&#39;doc&#39;</span><span class="p">][</span><span class="s1">&#39;road_data_id&#39;</span><span class="p">]</span>
                        <span class="k">except</span><span class="p">:</span>
                            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;cant find nearest road once&#39;</span><span class="p">)</span>

                        <span class="c1">## see if road_data_id already exists in our collection</span>
                        <span class="k">if</span> <span class="n">road_data_id</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">road_id_collection</span><span class="p">:</span>
                            <span class="n">road_id_collection</span><span class="p">[</span><span class="n">road_data_id</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>
                            <span class="n">geojson_road_id_collection</span> <span class="o">+=</span> <span class="p">[</span><span class="n">road_data_id</span><span class="p">]</span>
                        <span class="k">else</span><span class="p">:</span>
                            <span class="n">duplicate_road_id</span> <span class="o">+=</span> <span class="p">[</span><span class="n">road_data_id</span><span class="p">]</span>

            <span class="n">route_cached_insertion</span> <span class="o">=</span> <span class="p">{</span>
                <span class="s2">&quot;route_cached_id&quot;</span><span class="p">:</span> <span class="n">route_cached_id</span><span class="p">,</span>
                <span class="s2">&quot;geojson_road_id_collection&quot;</span><span class="p">:</span> <span class="n">geojson_road_id_collection</span>
            <span class="p">}</span>

            <span class="n">r</span><span class="o">.</span><span class="n">table</span><span class="p">(</span><span class="s1">&#39;route_cached&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="n">route_cached_insertion</span><span class="p">)</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">conn</span><span class="p">)</span>

            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;there are&#39;</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">duplicate_road_id</span><span class="p">),</span> <span class="s1">&#39;many duplicate road element&#39;</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;unique road element&#39;</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">road_id_collection</span><span class="p">))</span>
        
        <span class="k">else</span><span class="p">:</span>
            <span class="c1">## this branch means route_cached_doc has already existed </span>
            <span class="n">geojson_road_id_collection</span> <span class="o">=</span> <span class="n">route_cached_doc</span><span class="p">[</span><span class="s1">&#39;geojson_road_id_collection&#39;</span><span class="p">]</span>

        <span class="n">geojson_road_list</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">road_data_id</span> <span class="ow">in</span> <span class="n">geojson_road_id_collection</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">geojson_road_list</span> <span class="o">+=</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">fetch_geojson_item</span><span class="p">(</span><span class="n">road_data_id</span><span class="p">,</span> <span class="n">crawled_batch_id</span> <span class="o">=</span> <span class="n">crawled_batch_id</span><span class="p">)]</span>
            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;get_historic_traffic&#39;</span><span class="p">,</span> <span class="n">e</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">TrafficData</span><span class="o">.</span><span class="n">generate_geojson_collection</span><span class="p">(</span><span class="n">geojson_road_list</span><span class="p">)</span></div>

<div class="viewcode-block" id="TrafficData.get_historic_batch"><a class="viewcode-back" href="../../streettraffic.html#streettraffic.database.TrafficData.get_historic_batch">[docs]</a>    <span class="k">def</span> <span class="nf">get_historic_batch</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;This function generate the newest 100 crawled_batch list</span>
<span class="sd">        </span>
<span class="sd">        Returns:</span>
<span class="sd">            List: a list of object like </span>
<span class="sd">            ::</span>
<span class="sd">                {</span>
<span class="sd">                    &#39;crawled_timestamp&#39;: &#39;2017-06-19T19:29:37.845000+00:00&#39;,</span>
<span class="sd">                    &#39;id&#39;: &#39;a6f344c6-9941-41b4-aaf7-83e6ecab5ec2&#39;</span>
<span class="sd">                }</span>

<span class="sd">        Examples:</span>
<span class="sd">            &gt;&gt;&gt; traffic_server = TrafficServer(database_name=&quot;Traffic&quot;, database_ip=&quot;localhost&quot;)</span>
<span class="sd">            &gt;&gt;&gt; traffic_server.traffic_data.get_historic_batch()</span>
<span class="sd">            [{&#39;crawled_timestamp&#39;: &#39;2017-06-19T19:29:37.845000+00:00&#39;,</span>
<span class="sd">             &#39;id&#39;: &#39;a6f344c6-9941-41b4-aaf7-83e6ecab5ec2&#39;},</span>
<span class="sd">            {&#39;crawled_timestamp&#39;: &#39;2017-06-19T17:36:56.453000+00:00&#39;,</span>
<span class="sd">             &#39;id&#39;: &#39;3872cf48-e40d-4826-86aa-bc8ee1b36631&#39;},</span>
<span class="sd">            {&#39;crawled_timestamp&#39;: &#39;2017-06-19T17:20:00.645000+00:00&#39;,</span>
<span class="sd">             &#39;id&#39;: &#39;fbbc23d5-5bcb-4c99-af12-6b66022effcd&#39;}]</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">query_result</span> <span class="o">=</span> <span class="n">r</span><span class="o">.</span><span class="n">table</span><span class="p">(</span><span class="s1">&#39;crawled_batch&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">order_by</span><span class="p">(</span><span class="n">index</span> <span class="o">=</span> <span class="n">r</span><span class="o">.</span><span class="n">desc</span><span class="p">(</span><span class="s1">&#39;crawled_timestamp&#39;</span><span class="p">))</span><span class="o">.</span><span class="n">limit</span><span class="p">(</span><span class="mi">100</span><span class="p">)</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">conn</span><span class="p">)</span>
        <span class="n">batch_list</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">batch_item</span> <span class="ow">in</span> <span class="n">query_result</span><span class="p">:</span>
            <span class="n">batch_item</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s1">&#39;crawled_matrix_encoding&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
            <span class="n">batch_item</span><span class="p">[</span><span class="s1">&#39;crawled_timestamp&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">batch_item</span><span class="p">[</span><span class="s1">&#39;crawled_timestamp&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">isoformat</span><span class="p">()</span>
            <span class="n">batch_list</span> <span class="o">+=</span> <span class="p">[</span><span class="n">batch_item</span><span class="p">]</span>

        <span class="k">return</span> <span class="n">batch_list</span></div>

<div class="viewcode-block" id="TrafficData.get_crawled_batch_id_between"><a class="viewcode-back" href="../../streettraffic.html#streettraffic.database.TrafficData.get_crawled_batch_id_between">[docs]</a>    <span class="k">def</span> <span class="nf">get_crawled_batch_id_between</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">date_start</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">date_end</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">r</span><span class="o">.</span><span class="n">net</span><span class="o">.</span><span class="n">DefaultCursor</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;This function will get all the crawled_batch_id between date_start and date_end</span>

<span class="sd">        Args:</span>
<span class="sd">            date_start (str): an ISO 8601 format string indicating the starting date</span>
<span class="sd">            date_end (str): an ISO 8601 format string indicating the ending date</span>

<span class="sd">        Returns:</span>
<span class="sd">            r.net.DefaultCursor: a Cursor object of all crawled_batch_id in ``crawled_batch`` table that</span>
<span class="sd">            are between ``date_start`` and ``date_end``. You can use ``DefaultCursor.next()`` or </span>
<span class="sd">            ::</span>
<span class="sd">                for item in DefaultCursor:</span>
<span class="sd">                    print(item)  # do operation with item</span>

<span class="sd">            to interact with the resulting data</span>

<span class="sd">        Examples:</span>
<span class="sd">            &gt;&gt;&gt; traffic_server = TrafficServer(database_name=&quot;Traffic&quot;, database_ip=&quot;localhost&quot;)</span>
<span class="sd">            &gt;&gt;&gt; date_start = &quot;2017-06-28T14:20:00.000Z&quot;</span>
<span class="sd">            &gt;&gt;&gt; date_end = &quot;2017-06-28T23:20:00.000Z&quot;</span>
<span class="sd">            &gt;&gt;&gt; collection = traffic_server.traffic_data.get_crawled_batch_id_between(date_start, date_end)</span>
<span class="sd">            &gt;&gt;&gt; collection.next()</span>
<span class="sd">            &#39;ec65b3e5-7abb-484c-90c0-d943822b4402&#39;</span>
<span class="sd">            &gt;&gt;&gt; for item in collection:</span>
<span class="sd">            &gt;&gt;&gt;     print(item)</span>
<span class="sd">            5e5f9e07-d510-49ea-b19d-25e315e48c59</span>
<span class="sd">            7f43dcd9-462a-471f-b752-d031e7473d69</span>
<span class="sd">            45ffc64d-4130-4072-9b52-9cbce2329c62</span>
<span class="sd">            b26f0022-f003-4def-95e5-e6be291d5979</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1">## first step: change the date ISO-formatted datetime to python datetime.datetime object</span>
        <span class="n">date_start_datetime</span> <span class="o">=</span> <span class="n">parser</span><span class="o">.</span><span class="n">parse</span><span class="p">(</span><span class="n">date_start</span><span class="p">)</span>
        <span class="n">date_end_datetime</span> <span class="o">=</span> <span class="n">parser</span><span class="o">.</span><span class="n">parse</span><span class="p">(</span><span class="n">date_end</span><span class="p">)</span>

        <span class="c1">## second step: get all the crawled_batch_id related to this particular time interval </span>
        <span class="n">crawled_batch_id_collection</span> <span class="o">=</span> <span class="n">r</span><span class="o">.</span><span class="n">table</span><span class="p">(</span><span class="s1">&#39;crawled_batch&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">between</span><span class="p">(</span><span class="n">r</span><span class="o">.</span><span class="n">expr</span><span class="p">(</span><span class="n">date_start_datetime</span><span class="p">),</span> <span class="n">r</span><span class="o">.</span><span class="n">expr</span><span class="p">(</span><span class="n">date_end_datetime</span><span class="p">),</span> <span class="n">index</span><span class="o">=</span><span class="s2">&quot;crawled_timestamp&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">get_field</span><span class="p">(</span><span class="s1">&#39;crawled_batch_id&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">conn</span><span class="p">)</span>
        
        <span class="k">return</span> <span class="n">crawled_batch_id_collection</span></div>


<div class="viewcode-block" id="TrafficData.get_historic_traffic_between"><a class="viewcode-back" href="../../streettraffic.html#streettraffic.database.TrafficData.get_historic_traffic_between">[docs]</a>    <span class="k">def</span> <span class="nf">get_historic_traffic_between</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">routing_info</span><span class="p">:</span> <span class="n">Dict</span><span class="p">,</span> <span class="n">date_start</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">date_end</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">use_overview</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Given a routing_info, this function will get a historic_traffic </span>
<span class="sd">        for each crawled_batch_id between date_start and date_end.</span>
<span class="sd">        </span>
<span class="sd">        Args:</span>
<span class="sd">            routing_info (Dict): the routing JSON object from Google Javascript Direction API</span>
<span class="sd">            date_start (str): an ISO 8601 format string indicating the starting date</span>
<span class="sd">            date_end (str): an ISO 8601 format string indicating the ending date</span>
<span class="sd">            use_overview (bool): whether to use ``route[&#39;overview_polyline&#39;]`` to build ``route_cached_doc``.</span>
<span class="sd">                If set to be True, the execution will be generally faster, but you will have less coordiantes</span>
<span class="sd">                in your route_cached_doc.</span>

<span class="sd">        Returns:</span>
<span class="sd">            List: a list of object that looks like this</span>
<span class="sd">            ::</span>
<span class="sd">                {</span>
<span class="sd">                    &quot;crawled_batch_id&quot;: 5e5f9e07-d510-49ea-b19d-25e315e48c59</span>
<span class="sd">                    &quot;crawled_batch_id_traffic&quot;: object # a geojson object with respect to routing_info</span>
<span class="sd">                    &quot;crawled_timestamp&quot;: datetime.datetime(2017, 6, 28, 14, 20, tzinfo=tzutc())</span>
<span class="sd">                }</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">crawled_batch_id_collection</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_crawled_batch_id_between</span><span class="p">(</span><span class="n">date_start</span> <span class="o">=</span> <span class="n">date_start</span><span class="p">,</span> <span class="n">date_end</span> <span class="o">=</span> <span class="n">date_end</span><span class="p">)</span>
        <span class="n">multipe_geojson_collection</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">crawled_batch_id</span> <span class="ow">in</span> <span class="n">crawled_batch_id_collection</span><span class="p">:</span>
            <span class="n">multipe_geojson_collection</span> <span class="o">+=</span> <span class="p">[{</span>
                <span class="s2">&quot;crawled_batch_id&quot;</span><span class="p">:</span> <span class="n">crawled_batch_id</span><span class="p">,</span>
                <span class="s2">&quot;crawled_batch_id_traffic&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_historic_traffic</span><span class="p">(</span><span class="n">routing_info</span> <span class="o">=</span> <span class="n">routing_info</span><span class="p">,</span> <span class="n">crawled_batch_id</span> <span class="o">=</span> <span class="n">crawled_batch_id</span><span class="p">),</span>
                <span class="s2">&quot;crawled_timestamp&quot;</span><span class="p">:</span> <span class="n">r</span><span class="o">.</span><span class="n">table</span><span class="p">(</span><span class="s1">&#39;crawled_batch&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">crawled_batch_id</span><span class="p">)</span><span class="o">.</span><span class="n">get_field</span><span class="p">(</span><span class="s1">&#39;crawled_timestamp&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">conn</span><span class="p">)</span>
            <span class="p">}]</span>

        <span class="c1">## sort based on timestamp</span>
        <span class="n">multipe_geojson_collection</span><span class="o">.</span><span class="n">sort</span><span class="p">(</span><span class="n">key</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">item</span><span class="p">:</span> <span class="n">item</span><span class="p">[</span><span class="s1">&#39;crawled_timestamp&#39;</span><span class="p">])</span>

        <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">multipe_geojson_collection</span><span class="p">:</span>
            <span class="n">item</span><span class="p">[</span><span class="s1">&#39;crawled_timestamp&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">item</span><span class="p">[</span><span class="s1">&#39;crawled_timestamp&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">isoformat</span><span class="p">()</span>

        <span class="k">return</span> <span class="n">multipe_geojson_collection</span></div>

<div class="viewcode-block" id="TrafficData.get_historic_traffic_multiple_days"><a class="viewcode-back" href="../../streettraffic.html#streettraffic.database.TrafficData.get_historic_traffic_multiple_days">[docs]</a>    <span class="k">def</span> <span class="nf">get_historic_traffic_multiple_days</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">routing_info</span><span class="p">:</span> <span class="n">Dict</span><span class="p">,</span> <span class="n">date_start_end_list</span><span class="p">:</span> <span class="n">List</span><span class="p">):</span>
        <span class="n">multipe_geojson_collection</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">date_start_end_list</span><span class="p">:</span>
            <span class="n">date_start</span> <span class="o">=</span> <span class="n">item</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">date_end</span> <span class="o">=</span> <span class="n">item</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
            <span class="n">crawled_batch_id_collection</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_crawled_batch_id_between</span><span class="p">(</span><span class="n">date_start</span> <span class="o">=</span> <span class="n">date_start</span><span class="p">,</span> <span class="n">date_end</span> <span class="o">=</span> <span class="n">date_end</span><span class="p">)</span>

            <span class="k">for</span> <span class="n">crawled_batch_id</span> <span class="ow">in</span> <span class="n">crawled_batch_id_collection</span><span class="p">:</span>
                <span class="n">multipe_geojson_collection</span> <span class="o">+=</span> <span class="p">[{</span>
                    <span class="s2">&quot;crawled_batch_id&quot;</span><span class="p">:</span> <span class="n">crawled_batch_id</span><span class="p">,</span>
                    <span class="s2">&quot;crawled_batch_id_traffic&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_historic_traffic</span><span class="p">(</span><span class="n">routing_info</span> <span class="o">=</span> <span class="n">routing_info</span><span class="p">,</span> <span class="n">crawled_batch_id</span> <span class="o">=</span> <span class="n">crawled_batch_id</span><span class="p">),</span>
                    <span class="s2">&quot;crawled_timestamp&quot;</span><span class="p">:</span> <span class="n">r</span><span class="o">.</span><span class="n">table</span><span class="p">(</span><span class="s1">&#39;crawled_batch&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">crawled_batch_id</span><span class="p">)</span><span class="o">.</span><span class="n">get_field</span><span class="p">(</span><span class="s1">&#39;crawled_timestamp&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">conn</span><span class="p">)</span>
                <span class="p">}]</span>

        <span class="c1">## Notice this function is slightly different from get_historic_traffic_between. We don&#39;t sort it every time we add a date_start, date_end worth </span>
        <span class="c1">## of data.</span>
        <span class="n">multipe_geojson_collection</span><span class="o">.</span><span class="n">sort</span><span class="p">(</span><span class="n">key</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">item</span><span class="p">:</span> <span class="n">item</span><span class="p">[</span><span class="s1">&#39;crawled_timestamp&#39;</span><span class="p">])</span>

        <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">multipe_geojson_collection</span><span class="p">:</span>
            <span class="n">item</span><span class="p">[</span><span class="s1">&#39;crawled_timestamp&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">item</span><span class="p">[</span><span class="s1">&#39;crawled_timestamp&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">isoformat</span><span class="p">()</span>

        <span class="k">return</span> <span class="n">multipe_geojson_collection</span></div>



    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Analytics part of the module</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">_spatial_sampling_points</span><span class="p">(</span><span class="n">top</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span> <span class="n">bottom</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span> <span class="n">left</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span> <span class="n">right</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span> <span class="n">grid_point_distance</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">1000</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        will be depreciated. </span>


<span class="sd">        input: top: float, bottom: float, left: float, right: float,   where top and bottom are latitudes, left and right are longitudes</span>
<span class="sd">        grid_point_distance: int = 1000 (default unit: meters)</span>

<span class="sd">        NOTICE THIS FUNCTION DOES **NOT** HANDLE any region passes lon90 lat180</span>

<span class="sd">        example input: (41.49008, -71.312796, 42.49008, -72.3154396, grid_point_distance = 10)</span>
<span class="sd">        currently only support latlon</span>
<span class="sd">        the default grid_point_distance unit is meters</span>

<span class="sd">        This funciton will take two coordinate and create a rectangle area ready for query</span>
<span class="sd">        </span>
<span class="sd">        For example:</span>
<span class="sd">        ###^^^*^^^####  (in this example, top, bottom, left, right are denoted as *</span>
<span class="sd">        #  *^^^^^*   #   and this function should generate tile to cover the</span>
<span class="sd">        #  ^^^^^^^   #   area denoted by ^ and *)</span>
<span class="sd">        ###^^*^^^####</span>

<span class="sd">        Then, this function will create a even distribution of query points based on grid_point_distance</span>

<span class="sd">        For example:</span>
<span class="sd">        ###^$^$^$*####  (in this example, the query point are denoted as $)</span>
<span class="sd">        #  ^^^^^^^   #   </span>
<span class="sd">        #  ^$^$^$^   #   </span>
<span class="sd">        #  ^^^^^^^   #        </span>
<span class="sd">        ###*$^$^$^####</span>

<span class="sd">        Finally, we are going to query the nearst road around $ and return a list of road_data_id related to those points</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">horizontal_distance</span> <span class="o">=</span> <span class="n">Utility</span><span class="o">.</span><span class="n">get_distance</span><span class="p">((</span><span class="n">top</span><span class="p">,</span> <span class="n">left</span><span class="p">),</span> <span class="p">(</span><span class="n">top</span><span class="p">,</span> <span class="n">right</span><span class="p">))</span>  
        <span class="n">horizontal_divide_factor</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">horizontal_distance</span> <span class="o">/</span> <span class="n">grid_point_distance</span><span class="p">)</span>
        <span class="n">horizontal_point_diff</span> <span class="o">=</span> <span class="n">right</span> <span class="o">-</span> <span class="n">left</span>
        <span class="n">horizontal_increment</span> <span class="o">=</span> <span class="n">horizontal_point_diff</span> <span class="o">/</span> <span class="n">horizontal_divide_factor</span>

        <span class="n">vertical_distance</span> <span class="o">=</span> <span class="n">Utility</span><span class="o">.</span><span class="n">get_distance</span><span class="p">((</span><span class="n">top</span><span class="p">,</span> <span class="n">left</span><span class="p">),</span> <span class="p">(</span><span class="n">bottom</span><span class="p">,</span> <span class="n">left</span><span class="p">))</span>
        <span class="n">vertical_divide_factor</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">vertical_distance</span> <span class="o">/</span> <span class="n">grid_point_distance</span><span class="p">)</span>
        <span class="n">vertical_point_diff</span> <span class="o">=</span> <span class="n">top</span> <span class="o">-</span> <span class="n">bottom</span>
        <span class="n">vertical_increment</span> <span class="o">=</span> <span class="n">vertical_point_diff</span> <span class="o">/</span> <span class="n">vertical_divide_factor</span>
        <span class="nb">print</span><span class="p">(</span><span class="n">horizontal_distance</span><span class="p">,</span> <span class="n">vertical_distance</span><span class="p">)</span>

        <span class="n">sample_points</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">horizontal_divide_factor</span><span class="p">):</span>
            <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">vertical_divide_factor</span><span class="p">):</span>
                <span class="n">sample_points</span> <span class="o">+=</span> <span class="p">[[</span><span class="n">bottom</span> <span class="o">+</span> <span class="n">vertical_increment</span> <span class="o">*</span> <span class="n">j</span><span class="p">,</span> <span class="n">left</span> <span class="o">+</span> <span class="n">horizontal_increment</span> <span class="o">*</span> <span class="n">i</span><span class="p">]]</span>

        <span class="k">return</span> <span class="n">sample_points</span>

    <span class="nd">@staticmethod</span>
<div class="viewcode-block" id="TrafficData.spatial_sampling_points_polygon"><a class="viewcode-back" href="../../streettraffic.html#streettraffic.database.TrafficData.spatial_sampling_points_polygon">[docs]</a>    <span class="k">def</span> <span class="nf">spatial_sampling_points_polygon</span><span class="p">(</span><span class="n">polygon</span><span class="p">:</span> <span class="n">List</span><span class="p">,</span> <span class="n">grid_point_distance</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">1000</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;This function generates a list of sample points that are grid_point_distance away</span>
<span class="sd">        from each other within the polygon </span>
<span class="sd">        </span>
<span class="sd">        For example, let&#39;s use * to denote those points that construct the polygon:</span>

<span class="sd">        :: </span>

<span class="sd">            ###^^^*^^^####  (in this example, )</span>
<span class="sd">            #  *^^^^^*   #</span>
<span class="sd">            #  ^^^^^^^   #</span>
<span class="sd">            ###^^*^^^^####</span>

<span class="sd">        Then, this function will create a even distribution of query points based on grid_point_distance. For example:</span>

<span class="sd">        ::</span>

<span class="sd">            ###^$^$^$*####  (in this example, the sample point are denoted as $)</span>
<span class="sd">            #  ^^^^^^^   #   </span>
<span class="sd">            #  ^$^$^$^   #   </span>
<span class="sd">            #  ^^^^^^^   #        </span>
<span class="sd">            ###*$^$^$^####</span>

<span class="sd">        Args:</span>
<span class="sd">            polygon (List): a list of latlon coordiantes</span>
<span class="sd">            grid_point_distance (int): how far away is each point to each other (this is probably very bad english)</span>

<span class="sd">        Returns:</span>
<span class="sd">            List: a list of sample points within the polygon</span>

<span class="sd">        Examples:</span>
<span class="sd">            &gt;&gt;&gt; traffic_server = TrafficServer(database_name=&quot;Traffic&quot;, database_ip=&quot;localhost&quot;)</span>
<span class="sd">            &gt;&gt;&gt; polygon = [[33.75931214236421, -84.41242218017578], </span>
<span class="sd">                [33.77030054809328, -84.37989234924316], </span>
<span class="sd">                [33.75731409904876, -84.36701774597168],</span>
<span class="sd">                [33.745110752457876, -84.37491416931152],</span>
<span class="sd">                [33.74368334701714, -84.40461158752441],</span>
<span class="sd">                [33.75931214236421, -84.41242218017578]]</span>
<span class="sd">            &gt;&gt;&gt; traffic_server.traffic_data.spatial_sampling_points_polygon(polygon)</span>
<span class="sd">            [[33.75699194755521, -84.40107107162476],</span>
<span class="sd">            [33.75699194755521, -84.38971996307373],</span>
<span class="sd">            [33.75699194755521, -84.3783688545227]]</span>
<span class="sd">            &gt;&gt;&gt; # these are the sampling points that are 1000 meters away from each other</span>
<span class="sd">            &gt;&gt;&gt; # and all of them are within the specified polygon</span>

<span class="sd">        Note:</span>
<span class="sd">            This function does **NOT** handle any region passes lon90 lat180</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">top</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">polygon</span><span class="p">,</span> <span class="n">key</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">item</span><span class="p">:</span> <span class="n">item</span><span class="p">[</span><span class="mi">0</span><span class="p">])[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">bottom</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">polygon</span><span class="p">,</span> <span class="n">key</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">item</span><span class="p">:</span> <span class="n">item</span><span class="p">[</span><span class="mi">0</span><span class="p">])[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">right</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">polygon</span><span class="p">,</span> <span class="n">key</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">item</span><span class="p">:</span> <span class="n">item</span><span class="p">[</span><span class="mi">1</span><span class="p">])[</span><span class="mi">1</span><span class="p">]</span>
        <span class="n">left</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">polygon</span><span class="p">,</span> <span class="n">key</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">item</span><span class="p">:</span> <span class="n">item</span><span class="p">[</span><span class="mi">1</span><span class="p">])[</span><span class="mi">1</span><span class="p">]</span>
        <span class="n">shapely_polygon</span> <span class="o">=</span> <span class="n">Polygon</span><span class="p">(</span><span class="n">polygon</span><span class="p">)</span>

        <span class="n">horizontal_distance</span> <span class="o">=</span> <span class="n">Utility</span><span class="o">.</span><span class="n">get_distance</span><span class="p">((</span><span class="n">top</span><span class="p">,</span> <span class="n">left</span><span class="p">),</span> <span class="p">(</span><span class="n">top</span><span class="p">,</span> <span class="n">right</span><span class="p">))</span>  
        <span class="n">horizontal_divide_factor</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">horizontal_distance</span> <span class="o">/</span> <span class="n">grid_point_distance</span><span class="p">)</span>
        <span class="n">horizontal_point_diff</span> <span class="o">=</span> <span class="n">right</span> <span class="o">-</span> <span class="n">left</span>
        <span class="n">horizontal_increment</span> <span class="o">=</span> <span class="n">horizontal_point_diff</span> <span class="o">/</span> <span class="n">horizontal_divide_factor</span>

        <span class="n">vertical_distance</span> <span class="o">=</span> <span class="n">Utility</span><span class="o">.</span><span class="n">get_distance</span><span class="p">((</span><span class="n">top</span><span class="p">,</span> <span class="n">left</span><span class="p">),</span> <span class="p">(</span><span class="n">bottom</span><span class="p">,</span> <span class="n">left</span><span class="p">))</span>
        <span class="n">vertical_divide_factor</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">vertical_distance</span> <span class="o">/</span> <span class="n">grid_point_distance</span><span class="p">)</span>
        <span class="n">vertical_point_diff</span> <span class="o">=</span> <span class="n">top</span> <span class="o">-</span> <span class="n">bottom</span>
        <span class="n">vertical_increment</span> <span class="o">=</span> <span class="n">vertical_point_diff</span> <span class="o">/</span> <span class="n">vertical_divide_factor</span>

        <span class="n">sample_points</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">horizontal_divide_factor</span><span class="p">):</span>
            <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">vertical_divide_factor</span><span class="p">):</span>
                <span class="k">if</span> <span class="n">Point</span><span class="p">(</span><span class="n">bottom</span> <span class="o">+</span> <span class="n">vertical_increment</span> <span class="o">*</span> <span class="n">j</span><span class="p">,</span> <span class="n">left</span> <span class="o">+</span> <span class="n">horizontal_increment</span> <span class="o">*</span> <span class="n">i</span><span class="p">)</span><span class="o">.</span><span class="n">within</span><span class="p">(</span><span class="n">shapely_polygon</span><span class="p">):</span>
                    <span class="n">sample_points</span> <span class="o">+=</span> <span class="p">[[</span><span class="n">bottom</span> <span class="o">+</span> <span class="n">vertical_increment</span> <span class="o">*</span> <span class="n">j</span><span class="p">,</span> <span class="n">left</span> <span class="o">+</span> <span class="n">horizontal_increment</span> <span class="o">*</span> <span class="n">i</span><span class="p">]]</span>

        <span class="k">return</span> <span class="n">sample_points</span></div>

    <span class="nd">@staticmethod</span>
<div class="viewcode-block" id="TrafficData.format_list_points_for_display"><a class="viewcode-back" href="../../streettraffic.html#streettraffic.database.TrafficData.format_list_points_for_display">[docs]</a>    <span class="k">def</span> <span class="nf">format_list_points_for_display</span><span class="p">(</span><span class="n">list_points</span><span class="p">:</span> <span class="n">List</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;This function format the example inputs into a string that can be used</span>
<span class="sd">        to plot in https://www.darrinward.com/lat-long/</span>

<span class="sd">        Args:</span>
<span class="sd">            list_points (List): a list of latlon coordiantes</span>

<span class="sd">        Returns:</span>
<span class="sd">            str: print the string and plot it in </span>
<span class="sd">            https://www.darrinward.com/lat-long/</span>

<span class="sd">        Examples:</span>
<span class="sd">            &gt;&gt;&gt; traffic_server = TrafficServer(database_name=&quot;Traffic&quot;, database_ip=&quot;localhost&quot;)</span>
<span class="sd">            &gt;&gt;&gt; polygon = [[33.75931214236421, -84.41242218017578], </span>
<span class="sd">                [33.77030054809328, -84.37989234924316], </span>
<span class="sd">                [33.75731409904876, -84.36701774597168],</span>
<span class="sd">                [33.745110752457876, -84.37491416931152],</span>
<span class="sd">                [33.74368334701714, -84.40461158752441],</span>
<span class="sd">                [33.75931214236421, -84.41242218017578]]</span>
<span class="sd">            &gt;&gt;&gt; output = traffic_server.traffic_data.spatial_sampling_points_polygon(polygon)</span>
<span class="sd">            &gt;&gt;&gt; print(traffic_server.traffic_data.format_list_points_for_display(output))</span>
<span class="sd">            use https://www.darrinward.com/lat-long/ for plotting</span>
<span class="sd">            33.75699194755521,-84.40107107162476</span>
<span class="sd">            33.75699194755521,-84.38971996307373</span>
<span class="sd">            33.75699194755521,-84.3783688545227</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">formatted_string</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
        <span class="k">for</span> <span class="n">point</span> <span class="ow">in</span> <span class="n">list_points</span><span class="p">:</span>
            <span class="n">formatted_string</span> <span class="o">+=</span> <span class="nb">str</span><span class="p">(</span><span class="n">point</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
            <span class="n">formatted_string</span> <span class="o">+=</span> <span class="s2">&quot;,&quot;</span>
            <span class="n">formatted_string</span> <span class="o">+=</span> <span class="nb">str</span><span class="p">(</span><span class="n">point</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
            <span class="n">formatted_string</span> <span class="o">+=</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span>

        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;use https://www.darrinward.com/lat-long/ for plotting&#39;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">formatted_string</span></div>

<div class="viewcode-block" id="TrafficData.set_traffic_patter_monitoring_area"><a class="viewcode-back" href="../../streettraffic.html#streettraffic.database.TrafficData.set_traffic_patter_monitoring_area">[docs]</a>    <span class="k">def</span> <span class="nf">set_traffic_patter_monitoring_area</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">polygon</span><span class="p">:</span> <span class="n">List</span><span class="p">,</span> <span class="n">description</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">grid_point_distance</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">1000</span><span class="p">,</span> <span class="n">testing</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span> <span class="n">force</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;this function sample points within the polygon, store the nearest</span>
<span class="sd">        ``flow_item`` in a list and store the information in </span>
<span class="sd">        ``analytics_monitored_area`` table. </span>

<span class="sd">        Args:</span>
<span class="sd">            polygon (List): a list of latlon coordiantes</span>
<span class="sd">            description (str): a description of the monitoring area. e.g &#39;Atlanta_polygon&#39;</span>
<span class="sd">            grid_point_distance (int): how far away is each point to each other.</span>
<span class="sd">                The default value is set to 1000 meters</span>
<span class="sd">            testing (List): for testing purposes only. If set True,</span>
<span class="sd">                it prints out how many duplicate flow_item_id are there.</span>
<span class="sd">                Default is set to False.</span>
<span class="sd">            force (bool): whether to overide a analytics_monitored_area document</span>
<span class="sd">                if force == False, we raise an Exception</span>

<span class="sd">        Returns:</span>
<span class="sd">            None</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1">## analytics_monitored_area_id is automatically generated </span>
        <span class="n">sampling_points</span> <span class="o">=</span> <span class="n">TrafficData</span><span class="o">.</span><span class="n">spatial_sampling_points_polygon</span><span class="p">(</span><span class="n">polygon</span> <span class="o">=</span> <span class="n">polygon</span><span class="p">,</span> <span class="n">grid_point_distance</span> <span class="o">=</span> <span class="n">grid_point_distance</span><span class="p">)</span>
        <span class="n">polygon_encoding</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="n">polygon</span><span class="p">)[:</span><span class="mi">120</span><span class="p">]</span>  <span class="c1"># primary key&#39;s length is at most 127</span>
        <span class="n">analytics_monitored_area_insertion</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s2">&quot;analytics_monitored_area_id&quot;</span><span class="p">:</span> <span class="n">polygon_encoding</span><span class="p">,</span>
            <span class="s2">&quot;description&quot;</span><span class="p">:</span> <span class="n">description</span><span class="p">,</span>
            <span class="s2">&quot;list_points&quot;</span><span class="p">:</span> <span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="n">sampling_points</span><span class="p">),</span>
            <span class="s2">&quot;flow_item_id_collection&quot;</span><span class="p">:</span> <span class="p">[]</span>
        <span class="p">}</span>

        <span class="k">if</span> <span class="n">testing</span><span class="p">:</span>
            <span class="n">flow_item_id_duplicate</span> <span class="o">=</span> <span class="mi">0</span>

        <span class="k">for</span> <span class="n">point</span> <span class="ow">in</span> <span class="n">sampling_points</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">road_document</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_nearest_road</span><span class="p">(</span><span class="n">location_data</span><span class="o">=</span><span class="p">(</span><span class="n">point</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">point</span><span class="p">[</span><span class="mi">1</span><span class="p">]),</span> <span class="n">max_dist</span><span class="o">=</span><span class="mi">10000</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">road_document</span><span class="p">[</span><span class="s1">&#39;doc&#39;</span><span class="p">][</span><span class="s1">&#39;flow_item_id&#39;</span><span class="p">]</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">analytics_monitored_area_insertion</span><span class="p">[</span><span class="s1">&#39;flow_item_id_collection&#39;</span><span class="p">]:</span>
                    <span class="n">analytics_monitored_area_insertion</span><span class="p">[</span><span class="s1">&#39;flow_item_id_collection&#39;</span><span class="p">]</span> <span class="o">+=</span> <span class="p">[</span><span class="n">road_document</span><span class="p">[</span><span class="s1">&#39;doc&#39;</span><span class="p">][</span><span class="s1">&#39;flow_item_id&#39;</span><span class="p">]]</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">testing</span><span class="p">:</span>
                        <span class="n">flow_item_id_duplicate</span> <span class="o">+=</span> <span class="mi">1</span>
            <span class="k">except</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;get_nearest_road fail in set_traffic_patter_monitoring_area&#39;</span><span class="p">)</span>

        <span class="c1">## determine if we are inserting or updating , if it exist, we delete it and insert a new one</span>
        <span class="n">analytics_monitored_area_doc</span> <span class="o">=</span> <span class="n">r</span><span class="o">.</span><span class="n">table</span><span class="p">(</span><span class="s1">&#39;analytics_monitored_area&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">polygon_encoding</span><span class="p">)</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">conn</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">analytics_monitored_area_doc</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">force</span><span class="p">:</span>
                <span class="n">r</span><span class="o">.</span><span class="n">table</span><span class="p">(</span><span class="s1">&#39;analytics_monitored_area&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">polygon_encoding</span><span class="p">)</span><span class="o">.</span><span class="n">delete</span><span class="p">()</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">conn</span><span class="p">)</span>
                <span class="n">r</span><span class="o">.</span><span class="n">table</span><span class="p">(</span><span class="s1">&#39;analytics_monitored_area&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="n">analytics_monitored_area_insertion</span><span class="p">)</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">conn</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s1">&#39;monitored_area alerady exist, check your primary key&#39;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">r</span><span class="o">.</span><span class="n">table</span><span class="p">(</span><span class="s1">&#39;analytics_monitored_area&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="n">analytics_monitored_area_insertion</span><span class="p">)</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">conn</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">testing</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;flow_item_id_duplicate&#39;</span><span class="p">,</span> <span class="n">flow_item_id_duplicate</span><span class="p">)</span>


        <span class="k">return</span> <span class="n">analytics_monitored_area_insertion</span></div>

<div class="viewcode-block" id="TrafficData.get_analytics_monitored_area_description_collection"><a class="viewcode-back" href="../../streettraffic.html#streettraffic.database.TrafficData.get_analytics_monitored_area_description_collection">[docs]</a>    <span class="k">def</span> <span class="nf">get_analytics_monitored_area_description_collection</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;This function returns a list of ``description`` (the secondary key of </span>
<span class="sd">        the ``analytics_monitored_area`` table) of each analytics_monitored_area </span>
<span class="sd">        documents</span>

<span class="sd">        Returns:</span>
<span class="sd">            List</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">description_stream</span> <span class="o">=</span> <span class="n">r</span><span class="o">.</span><span class="n">db</span><span class="p">(</span><span class="s1">&#39;Traffic&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">table</span><span class="p">(</span><span class="s1">&#39;analytics_monitored_area&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">get_field</span><span class="p">(</span><span class="s1">&#39;description&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">conn</span><span class="p">)</span>
        <span class="n">description_collection</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">description</span> <span class="ow">in</span> <span class="n">description_stream</span><span class="p">:</span>
            <span class="n">description_collection</span> <span class="o">+=</span> <span class="p">[</span><span class="n">description</span><span class="p">]</span>

        <span class="k">return</span> <span class="n">description_collection</span></div>

 
<div class="viewcode-block" id="TrafficData.insert_analytics_traffic_pattern"><a class="viewcode-back" href="../../streettraffic.html#streettraffic.database.TrafficData.insert_analytics_traffic_pattern">[docs]</a>    <span class="k">def</span> <span class="nf">insert_analytics_traffic_pattern</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">analytics_monitored_area_id</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">crawled_batch_id</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">force</span> <span class="o">=</span> <span class="kc">False</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Insert a analytics_traffic_pattern document.</span>

<span class="sd">        Args:</span>
<span class="sd">            analytics_monitored_area_id (str): the primary key of table ``analytics_monitored_area``</span>
<span class="sd">            crawled_batch_id (str): the primary key of table ``crawled_batch``</span>
<span class="sd">            force (bool): whether to overide a analytics_traffic_pattern document</span>
<span class="sd">                if force == False, we raise an Exception</span>

<span class="sd">        Returns:</span>
<span class="sd">            None</span>

<span class="sd">        Example:</span>
<span class="sd">            &gt;&gt;&gt; typical_insertion  # this is an example of documents that are inserted</span>
<span class="sd">            {</span>
<span class="sd">                &quot;analytics_monitored_area_id&quot;:  &quot;[33.880079, 33.648894, -84.485086, -84.311365]&quot; ,</span>
<span class="sd">                &quot;analytics_traffic_pattern_id&quot;:  &quot;17e28c2e-bd09-478a-b880-767f2dc84cfa&quot; ,</span>
<span class="sd">                &quot;average_JF&quot;: 0.09392949526813882 ,</span>
<span class="sd">                &quot;crawled_batch_id&quot;:  &quot;25657665-b131-4ae7-bb13-7e26440cf8e0&quot; ,</span>
<span class="sd">                &quot;crawled_timestamp&quot;: Tue Jun 27 2017 07:00:00 GMT+00:00 ,</span>
<span class="sd">                &quot;flow_item_count&quot;: 317</span>
<span class="sd">            }</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">crawled_batch_id</span><span class="p">:</span>
            <span class="n">crawled_batch_id</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">latest_crawled_batch_id</span>

        <span class="c1">## 0 step: check if the document already existed, use force to determine whether to overrite </span>
        <span class="n">analytics_traffic_pattern</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_analytics_traffic_pattern</span><span class="p">(</span><span class="n">analytics_monitored_area_id</span><span class="p">,</span> <span class="n">crawled_batch_id</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">analytics_traffic_pattern</span><span class="p">:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">force</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;duplicate analytics_traffic_pattern_insertion, did not write, use force=True to override&#39;</span><span class="p">)</span>
                <span class="k">return</span>


        <span class="c1">## first step: get all the flow_items from table analytics_monitored_area</span>
        <span class="n">analytics_monitored_area_doc</span> <span class="o">=</span> <span class="n">r</span><span class="o">.</span><span class="n">table</span><span class="p">(</span><span class="s1">&#39;analytics_monitored_area&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">analytics_monitored_area_id</span><span class="p">)</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">conn</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">analytics_monitored_area_doc</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s1">&#39;no monitored_are found in analytics_monitored_area&#39;</span><span class="p">)</span>
        <span class="n">flow_item_id_collection</span> <span class="o">=</span>  <span class="n">analytics_monitored_area_doc</span><span class="p">[</span><span class="s1">&#39;flow_item_id_collection&#39;</span><span class="p">]</span>

        <span class="c1">## second step: set up the insertion document</span>
        <span class="n">crawled_batch_doc</span> <span class="o">=</span> <span class="n">r</span><span class="o">.</span><span class="n">table</span><span class="p">(</span><span class="s1">&#39;crawled_batch&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">crawled_batch_id</span><span class="p">)</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">conn</span><span class="p">)</span>
        <span class="n">analytics_traffic_pattern_insertion</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s1">&#39;crawled_batch_id&#39;</span><span class="p">:</span> <span class="n">crawled_batch_id</span><span class="p">,</span>
            <span class="s1">&#39;crawled_timestamp&#39;</span><span class="p">:</span> <span class="n">crawled_batch_doc</span><span class="p">[</span><span class="s1">&#39;crawled_timestamp&#39;</span><span class="p">],</span>
            <span class="s1">&#39;analytics_monitored_area_id&#39;</span><span class="p">:</span> <span class="n">analytics_monitored_area_id</span><span class="p">,</span>
            <span class="s1">&#39;average_JF&#39;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>
            <span class="s1">&#39;flow_item_count&#39;</span><span class="p">:</span><span class="nb">len</span><span class="p">(</span><span class="n">flow_item_id_collection</span><span class="p">)</span>
        <span class="p">}</span>

        <span class="c1">## third step: start to calculate the traffic_pattern</span>
        <span class="k">for</span> <span class="n">flow_item_id</span> <span class="ow">in</span> <span class="n">flow_item_id_collection</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">flow_data_JF</span> <span class="o">=</span> <span class="n">r</span><span class="o">.</span><span class="n">table</span><span class="p">(</span><span class="s1">&#39;flow_data&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">get_all</span><span class="p">([</span><span class="n">flow_item_id</span><span class="p">,</span> <span class="n">crawled_batch_id</span><span class="p">],</span> <span class="n">index</span> <span class="o">=</span> <span class="s2">&quot;flow_crawled_batch&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">get_field</span><span class="p">(</span><span class="s1">&#39;JF&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">limit</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">conn</span><span class="p">)</span><span class="o">.</span><span class="n">next</span><span class="p">()</span>
                <span class="n">analytics_traffic_pattern_insertion</span><span class="p">[</span><span class="s1">&#39;average_JF&#39;</span><span class="p">]</span> <span class="o">+=</span> <span class="n">flow_data_JF</span>
            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;insert_analytics_traffic_pattern&quot;</span><span class="p">,</span> <span class="n">e</span><span class="p">)</span>

        <span class="n">analytics_traffic_pattern_insertion</span><span class="p">[</span><span class="s1">&#39;average_JF&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">analytics_traffic_pattern_insertion</span><span class="p">[</span><span class="s1">&#39;average_JF&#39;</span><span class="p">]</span> <span class="o">/</span> <span class="n">analytics_traffic_pattern_insertion</span><span class="p">[</span><span class="s1">&#39;flow_item_count&#39;</span><span class="p">]</span>  <span class="c1"># get average</span>

        <span class="n">r</span><span class="o">.</span><span class="n">table</span><span class="p">(</span><span class="s1">&#39;analytics_traffic_pattern&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="n">analytics_traffic_pattern_insertion</span><span class="p">)</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">conn</span><span class="p">)</span></div>


<div class="viewcode-block" id="TrafficData.insert_analytics_traffic_pattern_between"><a class="viewcode-back" href="../../streettraffic.html#streettraffic.database.TrafficData.insert_analytics_traffic_pattern_between">[docs]</a>    <span class="k">def</span> <span class="nf">insert_analytics_traffic_pattern_between</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">date_start</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">date_end</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">analytics_monitored_area_id</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Insert ``analytics_traffic_pattern`` documents for each ``crawled_batch_id`` </span>
<span class="sd">        between ``date_start`` and ``date_end``. (given that you have inserted ``flow_data``</span>
<span class="sd">        documents between ``date_start`` and ``date_end``)</span>
<span class="sd">        </span>
<span class="sd">        Args:</span>
<span class="sd">            date_start (str): an ISO 8601 format string indicating the starting date</span>
<span class="sd">            date_end (str): an ISO 8601 format string indicating the ending date</span>
<span class="sd">            analytics_monitored_area_id (str): the primary key of table ``analytics_monitored_area``</span>

<span class="sd">        Returns:</span>
<span class="sd">            None</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1">## first step: change the date ISO-formatted datetime to python datetime.datetime object</span>
        <span class="n">date_start_datetime</span> <span class="o">=</span> <span class="n">parser</span><span class="o">.</span><span class="n">parse</span><span class="p">(</span><span class="n">date_start</span><span class="p">)</span>
        <span class="n">date_end_datetime</span> <span class="o">=</span> <span class="n">parser</span><span class="o">.</span><span class="n">parse</span><span class="p">(</span><span class="n">date_end</span><span class="p">)</span>

        <span class="c1">## second step: get all the crawled_batch_id related to this particular time interval and then insert them</span>
        <span class="c1">## by using insert_analytics_traffic_pattern()</span>
        <span class="n">crawled_batch_id_collection</span> <span class="o">=</span> <span class="n">r</span><span class="o">.</span><span class="n">table</span><span class="p">(</span><span class="s1">&#39;crawled_batch&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">between</span><span class="p">(</span><span class="n">r</span><span class="o">.</span><span class="n">expr</span><span class="p">(</span><span class="n">date_start_datetime</span><span class="p">),</span> <span class="n">r</span><span class="o">.</span><span class="n">expr</span><span class="p">(</span><span class="n">date_end_datetime</span><span class="p">),</span> <span class="n">index</span><span class="o">=</span><span class="s2">&quot;crawled_timestamp&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">get_field</span><span class="p">(</span><span class="s1">&#39;crawled_batch_id&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">conn</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">crawled_batch_id</span> <span class="ow">in</span> <span class="n">crawled_batch_id_collection</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">insert_analytics_traffic_pattern</span><span class="p">(</span><span class="n">analytics_monitored_area_id</span><span class="p">,</span> <span class="n">crawled_batch_id</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="n">e</span><span class="p">)</span></div>


<div class="viewcode-block" id="TrafficData.get_analytics_traffic_pattern"><a class="viewcode-back" href="../../streettraffic.html#streettraffic.database.TrafficData.get_analytics_traffic_pattern">[docs]</a>    <span class="k">def</span> <span class="nf">get_analytics_traffic_pattern</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">analytics_monitored_area_id</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">crawled_batch_id</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Given a ``analytics_monitored_area_id`` and ``crawled_batch_id``, </span>
<span class="sd">        fetch the related ``analytics_traffic_pattern`` documents</span>

<span class="sd">        Args:</span>
<span class="sd">            analytics_monitored_area_id (str): the primary key of table ``analytics_monitored_area``</span>
<span class="sd">            crawled_batch_id (str): the primary key of table ``crawled_batch``</span>

<span class="sd">        Returns:</span>
<span class="sd">            Dict: the corresponding ``analytics_traffic_pattern`` documents</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">crawled_batch_id</span><span class="p">:</span>
            <span class="n">crawled_batch_id</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">latest_crawled_batch_id</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">r</span><span class="o">.</span><span class="n">table</span><span class="p">(</span><span class="s1">&#39;analytics_traffic_pattern&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">get_all</span><span class="p">([</span><span class="n">analytics_monitored_area_id</span><span class="p">,</span> <span class="n">crawled_batch_id</span><span class="p">],</span> <span class="n">index</span> <span class="o">=</span> <span class="s2">&quot;analytics_crawled_batch&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">limit</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">conn</span><span class="p">)</span><span class="o">.</span><span class="n">next</span><span class="p">()</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="n">e</span><span class="p">)</span>
            <span class="k">return</span> <span class="kc">None</span></div>
        

<div class="viewcode-block" id="TrafficData.get_analytics_traffic_pattern_between"><a class="viewcode-back" href="../../streettraffic.html#streettraffic.database.TrafficData.get_analytics_traffic_pattern_between">[docs]</a>    <span class="k">def</span> <span class="nf">get_analytics_traffic_pattern_between</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> 
            <span class="n">date_start</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">date_end</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">analytics_monitored_area_description</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> 
            <span class="n">analytics_monitored_area_id</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Fetch all possible ``analytics_traffic_pattern`` documents</span>
<span class="sd">        between ``date_start`` and ``date_end`` for a ``analytics_monitored_area``</span>
<span class="sd">        documents</span>

<span class="sd">        Args:</span>
<span class="sd">            date_start (str): an ISO 8601 format string indicating the starting date</span>
<span class="sd">            date_end (str): an ISO 8601 format string indicating the ending date</span>
<span class="sd">            analytics_monitored_area_description (str): the secondary key of </span>
<span class="sd">                table ``analytics_monitored_area``</span>
<span class="sd">            analytics_monitored_area_id (str): the primary key of table </span>
<span class="sd">                ``analytics_monitored_area``. The default is set to None</span>
<span class="sd">                if specified, the program will fetch ``analytics_monitored_area``</span>
<span class="sd">                documents based on ``analytics_monitored_area_id`` rather than</span>
<span class="sd">                ``analytics_monitored_area_description``</span>

<span class="sd">        Returns:</span>
<span class="sd">            List: a list of all ``analytics_traffic_pattern`` documents</span>
<span class="sd">            between ``date_start`` and ``date_end`` for a ``analytics_monitored_area``</span>
<span class="sd">            documents</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">analytics_monitored_area_id</span><span class="p">:</span>
            <span class="n">analytics_monitored_area_id</span> <span class="o">=</span> <span class="n">r</span><span class="o">.</span><span class="n">table</span><span class="p">(</span><span class="s1">&#39;analytics_monitored_area&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">get_all</span><span class="p">(</span><span class="n">analytics_monitored_area_description</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="s2">&quot;description&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">get_field</span><span class="p">(</span><span class="s1">&#39;analytics_monitored_area_id&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">conn</span><span class="p">)</span><span class="o">.</span><span class="n">next</span><span class="p">()</span>
        <span class="nb">print</span><span class="p">(</span><span class="n">analytics_monitored_area_id</span><span class="p">)</span>
        <span class="c1">## First step: get all related crawled_id within the requested range: date_start to date_end</span>
        <span class="n">date_start_datetime</span> <span class="o">=</span> <span class="n">parser</span><span class="o">.</span><span class="n">parse</span><span class="p">(</span><span class="n">date_start</span><span class="p">)</span>
        <span class="n">date_end_datetime</span> <span class="o">=</span> <span class="n">parser</span><span class="o">.</span><span class="n">parse</span><span class="p">(</span><span class="n">date_end</span><span class="p">)</span>
        <span class="n">crawled_batch_id_collection</span> <span class="o">=</span> <span class="n">r</span><span class="o">.</span><span class="n">table</span><span class="p">(</span><span class="s1">&#39;crawled_batch&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">between</span><span class="p">(</span><span class="n">r</span><span class="o">.</span><span class="n">expr</span><span class="p">(</span><span class="n">date_start_datetime</span><span class="p">),</span> <span class="n">r</span><span class="o">.</span><span class="n">expr</span><span class="p">(</span><span class="n">date_end_datetime</span><span class="p">),</span> <span class="n">index</span><span class="o">=</span><span class="s2">&quot;crawled_timestamp&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">get_field</span><span class="p">(</span><span class="s1">&#39;crawled_batch_id&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">conn</span><span class="p">)</span>

        <span class="c1">## Second step: get all cooresponding traffic_pattern with respect to crawled_batch_id</span>
        <span class="n">traffic_pattern_collection</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">crawled_batch_id</span> <span class="ow">in</span> <span class="n">crawled_batch_id_collection</span><span class="p">:</span>
            <span class="n">traffic_pattern</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_analytics_traffic_pattern</span><span class="p">(</span><span class="n">analytics_monitored_area_id</span> <span class="o">=</span> <span class="n">analytics_monitored_area_id</span><span class="p">,</span> <span class="n">crawled_batch_id</span> <span class="o">=</span> <span class="n">crawled_batch_id</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">traffic_pattern</span><span class="p">:</span>
                <span class="n">traffic_pattern_collection</span> <span class="o">+=</span> <span class="p">[</span><span class="n">traffic_pattern</span><span class="p">]</span>

        <span class="c1"># Third step: sort the result based on timestamp</span>
        <span class="n">traffic_pattern_collection</span><span class="o">.</span><span class="n">sort</span><span class="p">(</span><span class="n">key</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">item</span><span class="p">:</span> <span class="n">item</span><span class="p">[</span><span class="s1">&#39;crawled_timestamp&#39;</span><span class="p">])</span>
        <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">traffic_pattern_collection</span><span class="p">:</span>
            <span class="n">item</span><span class="p">[</span><span class="s1">&#39;crawled_timestamp&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">item</span><span class="p">[</span><span class="s1">&#39;crawled_timestamp&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">isoformat</span><span class="p">()</span>


        <span class="k">return</span> <span class="n">traffic_pattern_collection</span></div></div>


</pre></div>

           </div>
           <div class="articleComments">
            
           </div>
          </div>
          <footer>
  

  <hr/>

  <div role="contentinfo">
    <p>
        &copy; Copyright 2017, Costa Huang.

    </p>
  </div>
  Built with <a href="http://sphinx-doc.org/">Sphinx</a> using a <a href="https://github.com/snide/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>

        </div>
      </div>

    </section>

  </div>
  


  

    <script type="text/javascript">
        var DOCUMENTATION_OPTIONS = {
            URL_ROOT:'../../',
            VERSION:'0.10',
            COLLAPSE_INDEX:false,
            FILE_SUFFIX:'.html',
            HAS_SOURCE:  true,
            SOURCELINK_SUFFIX: '.txt'
        };
    </script>
      <script type="text/javascript" src="../../_static/jquery.js"></script>
      <script type="text/javascript" src="../../_static/underscore.js"></script>
      <script type="text/javascript" src="../../_static/doctools.js"></script>
      <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.0/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>

  

  
  
    <script type="text/javascript" src="../../_static/js/theme.js"></script>
  

  
  
  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.StickyNav.enable();
      });
  </script>
   

</body>
</html>